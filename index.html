<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SUNENERGY Financial Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background:#f8f8ff;}
    .container { max-width: 900px; margin: auto; padding: 2rem;}
    h1 { color: #0a385d }
    table { width: 100%; border-collapse: collapse; margin-bottom: 1rem;}
    th,td { border: 1px solid #ccc; padding: 4px; text-align: left; }
    th { background: #ececec; }
    input,select,button {padding:4px 10px;}
    .sync-status { float:right;font-size:14px;margin-left:20px; }
    .backup-btns { margin-bottom: 1rem;}
    .success { color: green;}
    .error { color: red;}
  </style>
</head>
<body>
  <div class="container">
    <h1>SUNENERGY Financial Dashboard
      <span id="syncStatus" class="sync-status"></span>
    </h1>

    <div class="backup-btns">
      <button onclick="exportBackup()">Backup të Dhënave (Eksport)</button>
      <input type="file" id="importInput" onchange="importBackup(event)" style="display:none;">
      <button onclick="document.getElementById('importInput').click()">Import Backup (JSON)</button>
    </div>

    <h2>Transaksionet</h2>
    <table id="transactionsTable">
      <thead>
        <tr>
          <th>Data</th>
          <th>Tipi</th>
          <th>Përshkrimi</th>
          <th>Kategoria</th>
          <th>Shuma (MKD)</th>
          <th>Veprime</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <form id="addForm" onsubmit="return addTransaction()">
      <h3>Shto Transaksion të Ri</h3>
      <label>
        Data:
        <input id="inpDate" type="date" required />
      </label>
      <label>
        Tipi:
        <select id="inpType">
          <option>Shitje</option>
          <option>Shpenzim</option>
          <option>Tërheqje</option>
          <option>Investim</option>
          <option>Huamarrje</option>
          <option>Kthim i Huasë</option>
        </select>
      </label>
      <label>
        Përshkrimi:
        <input id="inpDesc" required />
      </label>
      <label>
        Kategoria:
        <input id="inpCat" required />
      </label>
      <label>
        Shuma
        <input id="inpAmount" type="number" step="1" required />
      </label>
      <button type="submit">Shto</button>
    </form>
  </div>

  <script>
    // Paste backup data inline (without "version" and "timestamp" for brevity)
    let transactions = [
      {"id":"1755587576529","data":"12-02-2025","tipi":"Shitje","pershkrimi":"Mjetet fillestare","kategoria":"Shitje","shuma":544},
      {"id":"1756052091504","data":"20-02-2025","tipi":"Shitje","pershkrimi":"Shitje rryme Duferco 01/25","kategoria":"Shitje","shuma":894752},
      {"id":"1756052166016","data":"28-02-2025","tipi":"Shpenzim","pershkrimi":"Mirembajtja e llogarise","kategoria":"Mirembajtja e Llogarise","shuma":-1990},
      {"id":"1756052314957","data":"04-03-2025","tipi":"Shitje","pershkrimi":"Entra Enerzi","kategoria":"Shitje","shuma":272138},
      {"id":"1756052376787","data":"05-03-2025","tipi":"Shpenzim","pershkrimi":"Kredi 03/25","kategoria":"Kesti per kredi","shuma":-531637},
      // *** VAZHDO ME TË GJITHA TË DHËNAT NGA BACKUP-JSON ***
      // Për arsye hapësire kopjo të gjithë array-t nga backup që ke
      // Shembull: {"id":"...","data":"...","tipi":"...","pershkrimi":"...","kategoria":"...","shuma":...}
    ];

    // VENDOS këtu URL-në tënde të Google Apps Script:
    const SYNC_URL = "https://script.google.com/macros/s/AKfycbw1LNphu8UN7QsUgRZ4Swa1YepCznWHfF7nr2C9ABwj3EQuAoqGz5-llwRhSgLNTQBt/exec";

    // INIT
    let local = false;

    document.addEventListener("DOMContentLoaded", () => {
      loadTable();
      syncGoogleSheets();
    });

    function loadTable() {
      const tbody = document.querySelector("#transactionsTable tbody");
      tbody.innerHTML = '';
      for (let i = 0; i < transactions.length; i++) {
        const t = transactions[i];
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${t.data || ""}</td>
          <td>${t.tipi || ""}</td>
          <td>${t.pershkrimi || ""}</td>
          <td>${t.kategoria || ""}</td>
          <td style="text-align:right">${t.shuma || 0}</td>
          <td>
            <button onclick="deleteTransaction('${t.id}')">Fshij</button>
          </td>
        `;
        tbody.appendChild(row);
      }
    }

    function addTransaction() {
      const date = document.getElementById('inpDate').value;
      const tipi = document.getElementById('inpType').value;
      const pershkrimi = document.getElementById('inpDesc').value;
      const kategoria = document.getElementById('inpCat').value;
      const shuma = parseInt(document.getElementById('inpAmount').value, 10);
      const id = "txn_" + Date.now() + "_" + Math.random().toString(36).substr(2,8);
      transactions.push({ id, data:date, tipi, pershkrimi, kategoria, shuma});
      loadTable();
      syncGoogleSheets();
      document.getElementById("addForm").reset();
      return false;
    }

    function deleteTransaction(id) {
      transactions = transactions.filter(t => t.id !== id);
      loadTable();
      syncGoogleSheets();
    }

    // Manual Backup Export
    function exportBackup() {
      const backup = {
        version: "1.0",
        timestamp: new Date().toISOString(),
        data: transactions
      };
      const blob = new Blob([JSON.stringify(backup, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `sunenergy_backup_${Date.now()}.json`;
      link.click();
    }

    // Manual Backup Import
    function importBackup(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(evt) {
          try {
            const imported = JSON.parse(evt.target.result);
            if (imported.data && Array.isArray(imported.data)) {
              transactions = imported.data;
            } else {
              transactions = Array.isArray(imported) ? imported : [];
            }
            loadTable();
            syncGoogleSheets();
          } catch(e) { alert("Gabim në import!"); }
        };
        reader.readAsText(file);
      }
    }

    // SYNC me Google Sheets
    function syncGoogleSheets() {
      updateSyncStatus("Duke sinkronizuar...", "black");
      fetch(SYNC_URL, {
        method: "POST",
        body: JSON.stringify(transactions),
        headers: { "Content-Type": "application/json" }
      })
      .then(r => r.json())
      .then(res => {
        if(res.status === "success") {
          updateSyncStatus("Sinkronizuar me sukses!", "green");
        } else {
          updateSyncStatus("Gabim në sinkronizim!", "red");
        }
      })
      .catch(() => updateSyncStatus("Gabim në lidhje!", "red"));
    }

    function updateSyncStatus(msg, color) {
      const el = document.getElementById('syncStatus');
      el.innerText = msg;
      el.style.color = color;
      setTimeout(() => { el.innerText = ''; }, 4000);
    }
  </script>
</body>
</html>
