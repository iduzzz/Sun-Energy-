<!DOCTYPE html>
<html lang="sq">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>SUNENERGY - Dashboard v2.0 Mobile</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Login Screen Styles - Safari Compatible */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            height: -webkit-fill-available; /* Safari iOS fix */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            overflow: hidden;
            /* Safari-specific fixes */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
        }
        
        .login-box {
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
            /* Safari mobile fixes */
            max-height: 85vh;
            max-height: -webkit-fill-available;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .login-logo {
            margin-bottom: 25px;
        }
        
        .login-logo h1 {
            font-size: 2.2em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
            -webkit-font-smoothing: antialiased;
        }
        
        .login-logo p {
            color: #86868b;
            font-size: 1em;
        }
        
        .login-form {
            margin-top: 25px;
        }
        
        .login-input {
            width: 100%;
            padding: 16px 18px;
            margin-bottom: 18px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 16px;
            font-size: 16px; /* Prevents zoom on iOS Safari */
            background: rgba(255, 255, 255, 0.95);
            transition: all 0.3s ease;
            /* Safari-specific input fixes */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            outline: none;
            box-sizing: border-box;
            /* Prevent Safari auto-zoom */
            transform: scale(1);
            transform-origin: left top;
            -webkit-text-size-adjust: 100%;
        }
        
        .login-input:focus {
            outline: none !important;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
            transform: scale(1);
            -webkit-transform: scale(1);
        }
        
        .login-input::-webkit-input-placeholder {
            color: #999;
        }
        .login-input:-moz-placeholder {
            color: #999;
            opacity: 1;
        }
        .login-input::-moz-placeholder {
            color: #999;
            opacity: 1;
        }
        .login-input:-ms-input-placeholder {
            color: #999;
        }
        
        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            /* Safari touch optimization */
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            /* Prevent Safari button styling */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .login-btn:hover, .login-btn:active, .login-btn:focus {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            outline: none;
        }
        
        .login-btn:disabled {
            opacity: 0.7;
            transform: none;
            cursor: not-allowed;
        }
        
        .login-error {
            color: #FF3B30;
            margin-top: 15px;
            font-size: 14px;
            font-weight: 500;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Storage Indicator */
        .storage-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: rgba(52, 199, 89, 0.9);
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .storage-indicator.warning {
            background: rgba(255, 159, 10, 0.9);
        }
        
        .storage-indicator.error {
            background: rgba(255, 59, 48, 0.9);
        }
        
        /* Prevent body scroll when login is active - Safari compatible */
        body.login-active {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100vh;
            height: -webkit-fill-available;
            -webkit-overflow-scrolling: touch;
        }
        
        .hidden {
            display: none !important;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
            min-height: 100vh;
            color: #1d1d1f;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
            min-height: 100vh;
        }
        
        /* Sidebar Dashboard */
        .sidebar {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .logo h1 {
            font-size: 2em;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }
        
        .logo p {
            font-size: 0.9em;
            color: #86868b;
        }
        
        .menu {
            list-style: none;
        }
        
        .menu-item {
            margin-bottom: 8px;
        }
        
        .menu-button {
            width: 100%;
            padding: 16px 20px;
            border: none;
            border-radius: 12px;
            background: transparent;
            text-align: left;
            font-size: 15px;
            font-weight: 500;
            color: #1d1d1f;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .menu-button:hover {
            background: rgba(0, 0, 0, 0.05);
            transform: translateY(-1px);
        }
        
        .menu-button.active {
            background: linear-gradient(135deg, #007AFF, #5856D6);
            color: white;
            box-shadow: 0 4px 20px rgba(0, 122, 255, 0.3);
        }
        
        .menu-button .icon {
            font-size: 18px;
            width: 20px;
        }
        
        /* Main Content */
        .main-content {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header {
            margin-bottom: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #1d1d1f 0%, #86868b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header p {
            color: #86868b;
            font-size: 1.1em;
        }
        
        /* Table */
        .table-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 40px;
        }
        
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 20px 0;
        }
        
        .main-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .main-table th {
            background: linear-gradient(135deg, #007AFF, #5856D6);
            color: white;
            padding: 20px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            letter-spacing: 0.5px;
        }
        
        .main-table td {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-size: 14px;
        }
        
        .main-table tr:hover {
            background: rgba(0, 122, 255, 0.03);
        }
        
        .main-table tr:last-child td {
            border-bottom: none;
        }
        
        .tip-shitje {
            border-left: 4px solid #34C759;
            background: rgba(52, 199, 89, 0.05);
        }
        
        .tip-shpenzim {
            border-left: 4px solid #FF9F0A;
            background: rgba(255, 159, 10, 0.05);
        }
        
        .tip-terheqje {
            border-left: 4px solid #AF52DE;
            background: rgba(175, 82, 222, 0.05);
        }
        
        .tip-huamarrje {
            border-left: 4px solid #007AFF;
            background: rgba(0, 122, 255, 0.05);
        }
        
        .tip-kthim-huase {
            border-left: 4px solid #FF3B30;
            background: rgba(255, 59, 48, 0.05);
        }
        
        /* Cards - Kompakte */
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }
        
        .summary-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        }
        
        .summary-card h3 {
            font-size: 0.9em;
            font-weight: 600;
            color: #86868b;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        
        .summary-card .amount {
            font-size: 1.6em;
            font-weight: 700;
            color: #1d1d1f;
        }
        
        .summary-card.positive .amount {
            color: #34C759;
        }
        
        .summary-card.negative .amount {
            color: #FF3B30;
        }
        
        .summary-card.warning {
            background: linear-gradient(135deg, rgba(255, 159, 10, 0.1), rgba(255, 204, 0, 0.1));
            border-left: 4px solid #FF9F0A;
        }
        
        .summary-card.warning .amount {
            color: #FF9F0A;
        }
        
        .summary-card.danger {
            background: linear-gradient(135deg, rgba(255, 59, 48, 0.1), rgba(255, 105, 97, 0.1));
            border-left: 4px solid #FF3B30;
        }
        
        .summary-card.danger .amount {
            color: #FF3B30;
        }
        
        .summary-card.info {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.1), rgba(88, 86, 214, 0.1));
            border-left: 4px solid #007AFF;
        }
        
        .summary-card.info .amount {
            color: #007AFF;
        }
        
        .summary-card.purple {
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.1), rgba(168, 85, 247, 0.1));
            border-left: 4px solid #9333EA;
        }
        
        .summary-card.purple .amount {
            color: #9333EA;
        }
        
        /* Kartela Mujore */
        .month-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .month-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 12px 40px rgba(59, 130, 246, 0.25);
        }
        
        .month-card:active {
            transform: translateY(-2px) scale(0.98);
        }
        
        .month-card h4 {
            font-size: 1.1em;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 12px;
        }
        
        .month-card .month-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 10px 0;
        }
        
        .month-card .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
        }
        
        .month-card .stat-label {
            color: #86868b;
        }
        
        .month-card .stat-value {
            font-weight: 600;
        }
        
        .month-card .stat-value.positive {
            color: #34C759;
        }
        
        .month-card .stat-value.negative {
            color: #FF3B30;
        }
        
        .month-card .stat-value.neutral {
            color: #007AFF;
        }
        
        .month-card .month-footer {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            font-size: 0.75em;
            color: #86868b;
        }
        
        .month-card.empty {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .month-card.empty:hover {
            transform: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .summary-card.clickable {
            transition: all 0.3s ease;
        }
        
        .summary-card.clickable:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        }
        
        .summary-card.positive.clickable:hover {
            box-shadow: 0 12px 40px rgba(52, 199, 89, 0.3);
        }
        
        .summary-card.negative.clickable:hover {
            box-shadow: 0 12px 40px rgba(255, 59, 48, 0.3);
        }
        
        .summary-card.primary.clickable:hover {
            box-shadow: 0 12px 40px rgba(59, 130, 246, 0.3);
        }
        
        .summary-card.warning.clickable:hover {
            box-shadow: 0 12px 40px rgba(255, 159, 10, 0.3);
        }
        
        .summary-card.danger.clickable:hover {
            box-shadow: 0 12px 40px rgba(255, 59, 48, 0.3);
        }
        
        .summary-card.info.clickable:hover {
            box-shadow: 0 12px 40px rgba(0, 122, 255, 0.3);
        }
        
        .summary-card.purple.clickable:hover {
            box-shadow: 0 12px 40px rgba(147, 51, 234, 0.3);
        }
        
        .summary-card.clickable:active {
            transform: translateY(-2px) scale(0.98);
        }
        
        /* Dashboard Analytics */
        .dashboard-analytics {
            margin-bottom: 40px;
        }
        
        .charts-container {
            margin: 30px 0;
        }
        
        .chart-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .chart-card.main-chart {
            width: 100%;
        }
        
        .chart-wrapper {
            height: 280px;
            position: relative;
        }
        
        .chart-wrapper canvas {
            border-radius: 12px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
        }
        
        .chart-title h3 {
            font-size: 1.4em;
            font-weight: 700;
            color: #1d1d1f;
            margin-bottom: 5px;
        }
        
        .chart-title p {
            color: #86868b;
            font-size: 0.95em;
        }
        
        .chart-filters {
            display: flex;
            gap: 12px;
        }
        
        .chart-filters select {
            padding: 8px 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            font-weight: 500;
            color: #1d1d1f;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .chart-filters select:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .progress-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }
        
        .progress-card, .activity-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .progress-header, .activity-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .progress-header h4, .activity-header h4 {
            font-size: 1.1em;
            font-weight: 700;
            color: #1d1d1f;
        }
        
        .progress-item {
            margin-bottom: 20px;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
            font-weight: 600;
            color: #1d1d1f;
        }
        
        .progress-bar {
            height: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.8s ease;
        }
        
        .progress-fill.sales {
            background: linear-gradient(90deg, #34C759, #30D158);
        }
        
        .progress-fill.profit {
            background: linear-gradient(90deg, #007AFF, #5856D6);
        }
        
        .progress-fill.efficiency {
            background: linear-gradient(90deg, #FF9F0A, #FFCC02);
        }
        
        .activity-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-item.empty {
            justify-content: center;
            text-align: center;
            padding: 40px 20px;
            color: #86868b;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .activity-icon.success {
            background: rgba(52, 199, 89, 0.1);
        }
        
        .activity-icon.warning {
            background: rgba(255, 159, 10, 0.1);
        }
        
        .activity-icon.purple {
            background: rgba(175, 82, 222, 0.1);
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-content p {
            font-size: 0.9em;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 2px;
        }
        
        .activity-content span {
            font-size: 0.8em;
            color: #86868b;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .table-header h2 {
            font-size: 1.5em;
            font-weight: 700;
            color: #1d1d1f;
        }
        
        .table-filters select {
            padding: 8px 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 14px;
        }
        
        .trend {
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .trend.positive {
            color: #34C759;
        }
        
        .trend.negative {
            color: #FF3B30;
        }
        
        .trend.neutral {
            color: #86868b;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #007AFF, #5856D6);
            color: white;
            box-shadow: 0 4px 20px rgba(0, 122, 255, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #34C759, #30D158);
            color: white;
            box-shadow: 0 4px 20px rgba(52, 199, 89, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #FF9F0A, #FFCC02);
            color: white;
            box-shadow: 0 4px 20px rgba(255, 159, 10, 0.3);
        }
        
        .btn-purple {
            background: linear-gradient(135deg, #AF52DE, #BF5AF2);
            color: white;
            box-shadow: 0 4px 20px rgba(175, 82, 222, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #FF3B30, #FF6961);
            color: white;
            box-shadow: 0 4px 20px rgba(255, 59, 48, 0.3);
            padding: 8px 16px;
            font-size: 12px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            margin: 2% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .modal-header h2 {
            font-size: 1.8em;
            font-weight: 700;
            color: #1d1d1f;
        }
        
        .close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.1);
            border: none;
            color: #86868b;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close:hover {
            background: rgba(255, 59, 48, 0.1);
            color: #FF3B30;
        }
        
        /* Form */
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1d1d1f;
            font-size: 14px;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 16px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.2s ease;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }
        
        /* Date input styling */
        .form-group input[type="date"] {
            position: relative;
        }
        
        .form-group input[type="date"]::-webkit-calendar-picker-indicator {
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23007AFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>') no-repeat center;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .empty-state {
            text-align: center;
            padding: 80px 40px;
            color: #86868b;
        }
        
        .empty-state h3 {
            font-size: 1.3em;
            margin-bottom: 12px;
            color: #1d1d1f;
        }
        
        .empty-state p {
            font-size: 1em;
        }
        
        /* ========== MOBILE NAVIGATION STYLES ========== */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: linear-gradient(135deg, #007AFF, #5856D6);
            padding: 12px 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .mobile-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 100%;
        }
        
        .mobile-logo {
            color: white;
            font-size: 1.2em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .hamburger-menu {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            color: white;
            font-size: 24px;
            min-width: 48px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .hamburger-menu:active {
            background: rgba(255,255,255,0.35);
            transform: scale(0.95);
        }
        
        /* Sidebar overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 998;
            backdrop-filter: blur(2px);
        }
        
        .sidebar-overlay.active {
            display: block;
        }
        
        /* Quick Action FAB (Floating Action Button) */
        .mobile-fab {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 900;
        }
        
        .fab-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #007AFF, #5856D6);
            border: none;
            color: white;
            font-size: 28px;
            box-shadow: 0 4px 20px rgba(0,122,255,0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .fab-button:active {
            transform: scale(0.9);
        }
        
        .fab-menu {
            position: absolute;
            bottom: 70px;
            right: 0;
            background: white;
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            min-width: 200px;
            display: none;
            flex-direction: column;
            gap: 6px;
        }
        
        .fab-menu.active {
            display: flex;
        }
        
        .fab-menu-item {
            padding: 12px 16px;
            border: none;
            background: transparent;
            text-align: left;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .fab-menu-item:active {
            background: rgba(0,122,255,0.1);
            transform: scale(0.98);
        }
        
        /* Responsive - Mobile First Approach */
        @media (max-width: 1400px) {
            .container {
                grid-template-columns: 280px 1fr;
                gap: 25px;
            }
        }
        
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                gap: 20px;
                max-width: 100%;
            }
            
            .sidebar {
                position: static;
                order: 2;
                padding: 20px;
            }
            
            .main-content {
                order: 1;
                padding: 25px;
            }
            
            .menu {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 12px;
            }
            .progress-section {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            .charts-container {
                margin: 20px 0;
            }
        }
        
        @media (max-width: 768px) {
            * {
                -webkit-tap-highlight-color: transparent;
            }
            
            /* MOBILE HEADER VISIBLE */
            .mobile-header {
                display: block;
            }
            
            /* MOBILE FAB VISIBLE */
            .mobile-fab {
                display: block;
            }
            
            body {
                padding-top: 60px;
            }
            
            .container {
                padding: 12px;
                gap: 0;
                grid-template-columns: 1fr;
                margin-top: 0;
            }
            
            /* SIDEBAR SLIDE-IN MOBILE */
            .sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100vh;
                width: 85%;
                max-width: 320px;
                z-index: 999;
                padding: 70px 20px 20px 20px;
                border-radius: 0;
                transition: left 0.3s ease;
                overflow-y: auto;
                box-shadow: 4px 0 20px rgba(0,0,0,0.3);
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .main-content {
                padding: 16px;
                border-radius: 16px;
                width: 100%;
            }
            
            /* SUMMARY CARDS - SINGLE COLUMN */
            .summary {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .summary-card {
                padding: 16px;
                cursor: pointer;
                min-height: 100px;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                border-radius: 14px;
            }
            
            .summary-card h3 {
                font-size: 0.75em;
                margin-bottom: 8px;
                line-height: 1.3;
                letter-spacing: 0.3px;
            }
            
            .summary-card .amount {
                font-size: 1.3em;
                line-height: 1.2;
                font-weight: 700;
            }
            
            .summary-card small {
                font-size: 0.7em !important;
            }
            
            /* HEADER */
            .header h1 {
                font-size: 1.4em;
                margin-bottom: 6px;
            }
            
            .header p {
                font-size: 0.85em;
            }
            
            /* CHARTS */
            .chart-wrapper {
                height: 220px;
            }
            
            .charts-container {
                margin: 20px 0;
            }
            
            .chart-card {
                padding: 16px;
                border-radius: 14px;
            }
            
            .chart-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .chart-filters {
                width: 100%;
                display: flex;
                gap: 8px;
            }
            
            .chart-filters select {
                flex: 1;
                padding: 10px;
                font-size: 13px;
                border-radius: 8px;
            }
            
            /* MODAL ULTRA OPTIMIZED */
            .modal-content {
                padding: 20px 16px;
                margin: 5% auto;
                width: 94%;
                max-width: 500px;
                max-height: 85vh;
                border-radius: 20px;
                overflow-y: auto;
            }
            
            .modal-header {
                margin-bottom: 20px;
                padding-bottom: 15px;
            }
            
            .modal-header h2 {
                font-size: 1.3em;
            }
            
            .close {
                font-size: 32px;
                width: 40px;
                height: 40px;
            }
            
            /* FORMS */
            .form-group {
                margin-bottom: 18px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 14px 12px;
                font-size: 16px;
                -webkit-appearance: none;
                border-radius: 12px;
                min-height: 50px;
                border: 2px solid rgba(0,0,0,0.1);
            }
            
            .form-group input:focus,
            .form-group select:focus,
            .form-group textarea:focus {
                border-color: #007AFF;
                box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
            }
            
            .form-group label {
                font-size: 14px;
                font-weight: 600;
                margin-bottom: 8px;
                display: block;
                color: #1d1d1f;
            }
            
            /* BUTTONS */
            .btn {
                padding: 14px 20px !important;
                font-size: 15px !important;
                min-height: 50px;
                border-radius: 12px !important;
                font-weight: 600;
            }
            
            .action-buttons {
                display: grid;
                grid-template-columns: 1fr;
                gap: 12px;
                margin: 20px 0;
            }
            
            .action-buttons .btn {
                width: 100%;
            }
            
            /* TABLE WRAPPER - HORIZONTAL SCROLL */
            .table-container {
                border-radius: 14px;
                margin: 0 -12px 20px -12px;
            }
            
            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0;
                padding: 0;
                border-radius: 0;
            }
            
            .main-table {
                font-size: 13px;
                min-width: 750px;
            }
            
            .main-table th {
                padding: 14px 10px;
                font-size: 13px;
                white-space: nowrap;
                position: sticky;
                top: 0;
                z-index: 10;
                background: linear-gradient(135deg, #007AFF, #5856D6);
            }
            
            .main-table td {
                padding: 14px 10px;
                font-size: 13px;
            }
            
            /* TABLE COLUMNS */
            .main-table td:nth-child(1) {
                min-width: 90px;
                font-weight: 600;
            }
            
            .main-table td:nth-child(2) {
                min-width: 100px;
                font-weight: 600;
            }
            
            .main-table td:nth-child(3) {
                min-width: 150px;
                max-width: 200px;
                white-space: normal;
                line-height: 1.4;
            }
            
            .main-table td:nth-child(4) {
                min-width: 100px;
            }
            
            .main-table td:nth-child(5) {
                min-width: 110px;
                font-size: 14px !important;
                font-weight: 700 !important;
                white-space: nowrap;
            }
            
            .main-table td:nth-child(6) {
                min-width: 160px;
                position: sticky;
                right: 0;
                background: white;
                box-shadow: -4px 0 8px rgba(0,0,0,0.08);
            }
            
            /* TABLE BUTTONS */
            .main-table td button {
                padding: 9px 14px !important;
                font-size: 12px !important;
                min-height: 38px;
                border-radius: 9px !important;
                font-weight: 600;
            }
            
            .main-table td button svg {
                width: 13px !important;
                height: 13px !important;
            }
            
            .main-table td > div {
                gap: 8px !important;
                display: flex;
                flex-wrap: nowrap;
            }
            
            /* LOGIN */
            .login-box {
                padding: 32px 24px;
                width: 92%;
                max-width: 400px;
                border-radius: 20px;
            }
            
            .login-logo h1 {
                font-size: 2em;
            }
            
            .login-input {
                padding: 16px 14px;
                font-size: 16px;
                min-height: 52px;
                border-radius: 12px;
            }
            
            .login-button {
                min-height: 52px;
                font-size: 16px;
                border-radius: 12px;
                font-weight: 600;
            }
            
            /* SIDEBAR BUTTONS */
            .sidebar .btn {
                font-size: 14px;
                padding: 12px 16px;
                min-height: 48px;
            }
            
            .menu-button {
                padding: 14px 16px;
                font-size: 14px;
                min-height: 48px;
                border-radius: 12px;
            }
            
            .menu {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .menu-item {
                margin-bottom: 0;
            }
            
            /* LOGO IN SIDEBAR */
            .logo {
                margin-bottom: 24px;
                padding-bottom: 20px;
            }
            
            .logo h1 {
                font-size: 1.8em;
            }
            
            .logo p {
                font-size: 0.9em;
            }
            
            /* CHARTS */
            canvas {
                max-height: 220px !important;
            }
            
            /* FILTERS */
            .filters {
                padding: 14px;
                border-radius: 14px;
                margin-bottom: 16px;
            }
            
            .filters h3 {
                font-size: 1em;
                margin-bottom: 12px;
            }
            
            .filters select,
            .filters input {
                font-size: 14px;
                padding: 11px;
                min-height: 48px;
                border-radius: 10px;
                border: 2px solid rgba(0,0,0,0.1);
                margin-bottom: 10px;
                width: 100%;
            }
            
            .filters button {
                width: 100%;
                margin-top: 8px;
            }
            
            /* STORAGE INDICATOR */
            .storage-indicator {
                font-size: 11px;
                padding: 6px 12px;
                border-radius: 8px;
            }
            
            /* PROGRESS */
            .progress-item {
                margin-bottom: 14px;
            }
            
            .progress-label {
                font-size: 13px;
                margin-bottom: 6px;
            }
            
            /* DASHBOARD ANALYTICS */
            .dashboard-analytics {
                margin-top: 20px;
            }
            
            /* EMPTY STATE */
            .empty-state {
                padding: 40px 20px !important;
            }
            
            .empty-state h3 {
                font-size: 1.1em;
            }
            
            .empty-state p {
                font-size: 0.9em;
            }
        }
        
        /* Extra small devices (iPhone SE, etc) - ULTRA OPTIMIZED */
        @media (max-width: 480px) {
            body {
                padding-top: 58px;
            }
            
            .mobile-header {
                padding: 10px 14px;
            }
            
            .mobile-logo {
                font-size: 1.1em;
            }
            
            .hamburger-menu {
                min-width: 44px;
                min-height: 44px;
                font-size: 22px;
            }
            
            .container {
                padding: 10px;
            }
            
            .main-content {
                padding: 14px;
            }
            
            .summary {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .summary-card {
                padding: 14px;
                min-height: 95px;
            }
            
            .summary-card .amount {
                font-size: 1.2em;
            }
            
            .summary-card h3 {
                font-size: 0.7em;
            }
            
            .header h1 {
                font-size: 1.2em;
            }
            
            .header p {
                font-size: 0.8em;
            }
            
            .modal-content {
                width: 96%;
                padding: 18px 14px;
            }
            
            .login-box {
                width: 94%;
                padding: 28px 20px;
            }
            
            .main-table {
                font-size: 12px;
                min-width: 700px;
            }
            
            .main-table th {
                padding: 12px 8px;
                font-size: 12px;
            }
            
            .main-table td {
                padding: 12px 8px;
                font-size: 12px;
            }
            
            .main-table td:nth-child(6) {
                min-width: 150px;
            }
            
            .main-table td button {
                padding: 8px 11px !important;
                font-size: 11px !important;
                min-height: 36px;
            }
            
            .btn {
                font-size: 14px !important;
                padding: 13px 18px !important;
            }
            
            .filters select,
            .filters input {
                font-size: 14px;
                padding: 10px;
            }
            
            .chart-wrapper {
                height: 200px;
            }
            
            canvas {
                max-height: 200px !important;
            }
            
            .fab-button {
                width: 56px;
                height: 56px;
                font-size: 26px;
            }
            
            .fab-menu {
                min-width: 180px;
                bottom: 66px;
            }
            
            .fab-menu-item {
                padding: 11px 14px;
                font-size: 13px;
            }
        }
        
        /* iPad Pro and Tablet Landscape */
        @media (min-width: 768px) and (max-width: 1024px) {
            .container {
                grid-template-columns: 260px 1fr;
                gap: 25px;
            }
            .summary {
                grid-template-columns: repeat(3, 1fr);
            }
            .progress-section {
                grid-template-columns: 1fr 1fr;
            }
            .chart-wrapper {
                height: 300px;
            }
        }
        
        /* Large tablets and small laptops */
        @media (min-width: 1024px) and (max-width: 1200px) {
            .summary {
                grid-template-columns: repeat(5, 1fr);
            }
            .container {
                grid-template-columns: 280px 1fr;
            }
        }
    


.action-buttons {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    padding: 0 6px;
}
.btn-danger, .btn-primary {
    padding: 6px 12px;
    font-size: 12px;
}


.main-table td:last-child, .main-table th:last-child {
    width: 160px; /* zgjeron kolonën e veprimeve */
    text-align: center;
}


.btn-primary {
    background-color: #4a90e2;
    border: none;
    color: white;
    transition: background-color 0.3s ease;
}
.btn-primary:hover {
    background-color: #357abd;
}

.btn-danger {
    background-color: #e74c3c;
    border: none;
    color: white;
    transition: background-color 0.3s ease;
}
.btn-danger:hover {
    background-color: #c0392b;
}


.nav-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 16px;
    margin: 4px;
    font-size: 14px;
    font-weight: bold;
    border-radius: 8px;
    border: none;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
}
.nav-button:hover {
    transform: translateY(-2px);
}

/* Ngjyra specifike për secilin buton */
.btn-shpenzim {
    background-color: #e67e22;
}
.btn-shpenzim:hover {
    background-color: #ca6f1e;
}
.btn-shitje {
    background-color: #27ae60;
}
.btn-shitje:hover {
    background-color: #1e8449;
}
.btn-investim {
    background-color: #2980b9;
}
.btn-investim:hover {
    background-color: #21618c;
}


/* Tabela kryesore */
.main-table {
    border-collapse: collapse;
    width: 100%;
    font-size: 14px;
    background: white;
    border-radius: 8px;
    overflow: hidden;
}
.main-table th, .main-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
}
.main-table th {
    background-color: #f2f2f2;
    font-weight: bold;
}
.main-table tr:nth-child(even) {
    background-color: #f9f9f9;
}
.main-table tr:hover {
    background-color: #f1f1f1;
}

/* Filtrat */
.filter-section {
    margin: 20px 0;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}
.filter-section input, .filter-section select {
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 14px;
}
.filter-section button {
    padding: 8px 14px;
    background-color: #3498db;
    border: none;
    border-radius: 6px;
    color: white;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s ease;
}
.filter-section button:hover {
    background-color: #2980b9;
}

/* Kartat e Përmbledhjes */
.card {
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    padding: 16px;
    margin: 10px;
    background: white;
    transition: transform 0.2s ease;
}
.card:hover {
    transform: translateY(-3px);
}


body {
    background: linear-gradient(135deg, #f0f4f8, #d9e4ec);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

</style>
</head>
<body>
    <!-- Mobile Header -->
    <div class="mobile-header">
        <div class="mobile-header-content">
            <div class="mobile-logo">
                <span>⚡</span>
                <span>SUNENERGY</span>
            </div>
            <button class="hamburger-menu" onclick="toggleSidebar()">
                ☰
            </button>
        </div>
    </div>
    
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    
    <!-- Floating Action Button -->
    <div class="mobile-fab">
        <button class="fab-button" onclick="toggleFabMenu()">
            +
        </button>
        <div class="fab-menu" id="fabMenu">
            <button class="fab-menu-item" onclick="hapModal('shitje'); toggleFabMenu();">
                <span>💰</span>
                <span>Shitje</span>
            </button>
            <button class="fab-menu-item" onclick="hapModal('shpenzim'); toggleFabMenu();">
                <span>🔋</span>
                <span>Shpenzim</span>
            </button>
            <button class="fab-menu-item" onclick="hapModal('terheqje'); toggleFabMenu();">
                <span>💸</span>
                <span>Tërheqje</span>
            </button>
            <button class="fab-menu-item" onclick="hapModal('investim'); toggleFabMenu();">
                <span>💼</span>
                <span>Investim</span>
            </button>
        </div>
    </div>
    
    <!-- Storage Indicator -->
    <div id="storage-indicator" class="storage-indicator hidden">
        💾 Data e ruajtur
    </div>

    <!-- Login Screen -->
    <div id="login-container" class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <h1>⚡ SUNENERGY</h1>
                <p>Financial Dashboard</p>
            </div>
            
            <form class="login-form" onsubmit="handleLogin(event)">
                <div style="text-align: center; margin-bottom: 20px;">
                    <p style="color: #86868b; font-size: 0.95em;">
                        Klikoni butonin për të hyrë në dashboard
                    </p>
                </div>
                <button type="submit" class="login-btn">
                    🚀 Hyr në Dashboard
                </button>
            </form>
        </div>
    </div>

    <!-- Main Dashboard (Initially Hidden) -->
    <div id="main-dashboard" class="container hidden">
        <!-- Sidebar Dashboard -->
        <div class="sidebar">
            <div class="logo">
                <h1>⚡ SUNENERGY</h1>
                <p>Nexha & Gresa</p>
            </div>
            
            <ul class="menu">
                <li class="menu-item">
                    <button class="menu-button" onclick="hapModal('shitje')">
                        <span class="icon">💰</span>
                        Regjistro Shitje
                    </button>
                </li>
                <li class="menu-item">
                    <button class="menu-button" onclick="hapModal('shpenzim')">
                        <span class="icon">🔋</span>
                        Regjistro Shpenzim
                    </button>
                </li>
                <li class="menu-item">
                    <button class="menu-button" onclick="hapModal('terheqje')">
                        <span class="icon">💸</span>
                        Regjistro Tërheqje
                    </button>
                </li>
                </li>
                <li class="menu-item">
                    <button class="menu-button" onclick="hapModal('investim')">
                        <span class="icon">💼</span>
                        Regjistro Investim
                    </button>
                </li>
                <li class="menu-item">
                    <button class="menu-button" onclick="hapModal('huamarrje')">
                        <span class="icon">🤝</span>
                        Regjistro Huamarrje
                    </button>
                </li>
                <li class="menu-item">
                    <button class="menu-button" onclick="hapModal('kthim-huase')">
                        <span class="icon">💳</span>
                        Kthim i Huasë
                    </button>
                </li>
                <li class="menu-item">
                <li class="menu-item">
                    <button class="menu-button" onclick="hapModal('raport')">
                        <span class="icon">📅</span>
                        Raporte Mujore
                    </button>
                </li>
                <li class="menu-item">
                    <button class="menu-button" onclick="hapModal('vjetor')">
                        <span class="icon">📈</span>
                        Raporti Vjetor
                    </button>
                </li>
                <li class="menu-item">
                    <button class="menu-button" onclick="eksportoNeExcel()">
                        <span class="icon">📄</span>
                        Eksporto Excel
                    </button>
                </li>
                <li class="menu-item">
                    <button class="menu-button" onclick="backupData()">
                        <span class="icon">💾</span>
                        Backup të Dhënave
                    </button>
                </li>
                <li class="menu-item">
                    <button class="menu-button" onclick="importData()">
                        <span class="icon">📥</span>
                        Importo të Dhëna
                    </button>
                </li>
                <li class="menu-item" style="margin-top: 20px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 15px;">
                    <button class="menu-button" onclick="logout()" style="color: #FF3B30;">
                        <span class="icon">🚪</span>
                        Dil nga Sistemi
                    </button>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1>Financial Dashboard</h1>
                <p>Menaxhimi profesional i financave të kompanisë</p>
            </div>

            <!-- Tabela Kryesore - E para -->
            <div class="table-container">
                <div class="table-header">
                    <h2>📊 Të Gjitha Transaksionet</h2>
                    <div class="table-filters" style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <select id="filter-muaji" onchange="filtroTabelen()">
                            <option value="">Të gjitha muajt</option>
                            <option value="01">Janar</option>
                            <option value="02">Shkurt</option>
                            <option value="03">Mars</option>
                            <option value="04">Prill</option>
                            <option value="05">Maj</option>
                            <option value="06">Qershor</option>
                            <option value="07">Korrik</option>
                            <option value="08">Gusht</option>
                            <option value="09">Shtator</option>
                            <option value="10">Tetor</option>
                            <option value="11">Nëntor</option>
                            <option value="12">Dhjetor</option>
                        </select>
                        <select id="filter-type" onchange="filtroTabelen()">
                            <option value="">Të gjitha tipet</option>
                            <option value="Shitje">Shitjet</option>
                            <option value="Shpenzim">Shpenzimet</option>
                            <option value="Tërheqje">Tërheqjet</option>
                            <option value="Investim">Investimet</option>
                            <option value="Huamarrje">Huamarrjet</option>
                            <option value="Kthim i Huasë">Kthim i Huasë</option>
</select>
                        <input type="text" id="filter-pershkrimi" placeholder="Filtro sipas përshkrimit..." onkeyup="filtroTabelen()" style="padding: 8px 12px; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 8px; background: rgba(255, 255, 255, 0.9); font-size: 14px;">
                        <select id="filter-kategoria" onchange="filtroTabelen()">
                            <option value="">Të gjitha kategoritë</option>
                            <option value="Shitje">Shitje</option>
                            <option value="Material">Material</option>
                            <option value="Transport">Transport</option>
                            <option value="Paga Zudi">Paga Zudi</option>
                            <option value="Qira">Qira</option>
                            <option value="Rrymë">Rrymë</option>
                            <option value="Telekom internet">Telekom internet</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Tatim TVSH">Tatim TVSH</option>
                            <option value="Kesti për kredi">Kesti për kredi</option>
                            <option value="Akontacion">Akontacion</option>
                            <option value="Mirëmbajtja e llogarisë bankare">Mirëmbajtja e llogarisë bankare</option>
                            <option value="Kontabilitet">Kontabilitet</option>
                            <option value="Nexha">Nexha</option>
                            <option value="Gresa">Gresa</option>
                            <option value="Të tjera">Të tjera</option>
                        </select>
                        <button class="btn btn-primary" onclick="pastroFiltrat()" style="padding: 8px 16px; font-size: 14px;">
                            🔄 Pastro Filtrat
                        </button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="main-table">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0, 'date')" style="cursor:pointer">Data ▲▼</th>
                                <th onclick="sortTable(1, 'text')" style="cursor:pointer">Tipi ▲▼</th>
                                <th onclick="sortTable(2, 'text')" style="cursor:pointer">Përshkrimi ▲▼</th>
                                <th onclick="sortTable(3, 'text')" style="cursor:pointer">Kategoria ▲▼</th>
                                <th onclick="sortTable(4, 'number')" style="cursor:pointer">Shuma ▲▼</th>
                                <th>Veprime</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-kryesore">
                            <tr>
                                <td colspan="6" class="empty-state">
                                    <h3>🌟 Mirë se vini në SUNENERGY Dashboard!</h3>
                                    <p>Përdorni menunë në të majtë për të filluar regjistrimin e transaksioneve.</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Dashboard Analytics - Në fund -->
            <div class="dashboard-analytics">
                <!-- Summary Cards - Lart -->
                <div class="summary">
                    <div class="summary-card positive clickable" onclick="shfaqDetajeShitje()" style="cursor: pointer;">
                        <h3>TOTALI I SHITJEVE</h3>
                        <div class="amount" id="total-shitje">0.00 MKD</div>
                        <div class="trend" id="trend-shitje">+0%</div>
                        <small style="font-size: 0.7em; opacity: 0.8; margin-top: 5px; display: block;">Kliko për detaje</small>
                    </div>
                    <div class="summary-card negative clickable" onclick="shfaqDetajeShpenzime()" style="cursor: pointer;">
                        <h3>TOTALI I SHPENZIMEVE</h3>
                        <div class="amount" id="total-shpenzime">0.00 MKD</div>
                        <div class="trend" id="trend-shpenzime">+0%</div>
                        <small style="font-size: 0.7em; opacity: 0.8; margin-top: 5px; display: block;">Kliko për detaje</small>
                    </div>
                    <div class="summary-card primary clickable" onclick="shfaqDetajeFitimi()" style="cursor: pointer;">
                        <h3>FITIMI BRUTO</h3>
                        <div class="amount" id="fitimi-bruto">0.00 MKD</div>
                        <div class="trend" id="trend-fitimi">+0%</div>
                        <small style="font-size: 0.7em; opacity: 0.8; margin-top: 5px; display: block;">Kliko për detaje</small>
                    </div>

                    <div class="summary-card clickable" onclick="shfaqDetajePjesaNexha()" style="cursor: pointer;">
                        <h3>SA I MBETET NEXHA</h3>
                        <div class="amount" id="pjesa-nexha">0.00 MKD</div>
                        <small style="font-size: 0.7em; opacity: 0.8; margin-top: 5px; display: block;">Kliko për detaje</small>
                    </div>
                    <div class="summary-card clickable" onclick="shfaqDetajePjesaGresa()" style="cursor: pointer;">
                        <h3>SA I MBETET GRESA</h3>
                        <div class="amount" id="pjesa-gresa">0.00 MKD</div>
                        <small style="font-size: 0.7em; opacity: 0.8; margin-top: 5px; display: block;">Kliko për detaje</small>
                    </div>
                    <div class="summary-card purple clickable" onclick="shfaqDetajeTerheqje('Nexha')" style="cursor: pointer;">
                        <h3>💸 TËRHEQJET NEXHA</h3>
                        <div class="amount" id="terheqjet-nexha">0.00 MKD</div>
                        <small style="font-size: 0.7em; opacity: 0.8;">Kliko për detaje</small>
                    </div>
                    <div class="summary-card purple clickable" onclick="shfaqDetajeTerheqje('Gresa')" style="cursor: pointer;">
                        <h3>💸 TËRHEQJET GRESA</h3>
                        <div class="amount" id="terheqjet-gresa">0.00 MKD</div>
                        <small style="font-size: 0.7em; opacity: 0.8;">Kliko për detaje</small>
                    </div>
                </div>

                <!-- Charts Row - Ultra Kompakt -->
                <div class="charts-container">
                    <!-- Single Compact Chart -->
                    <div class="chart-card main-chart">
                        <div class="chart-header">
                            <div class="chart-title">
                                <h3>📈 Analiza Mujore</h3>
                                <p>Performanca mujore e kompanisë</p>
                            </div>
                            <div class="chart-filters">
                                <select id="chart-filter" onchange="updateChartView()">
                                    <option value="both">Shitjet & Shpenzimet</option>
                                    <option value="sales">Vetëm Shitjet</option>
                                    <option value="expenses">Vetëm Shpenzimet</option>
                                    <option value="profit">Fitimi Mujor</option>
                                </select>
                                <select id="chart-year" onchange="updateChartView()">
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2026">2026</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal për Shitje -->
    <div id="modal-shitje" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>💰 Regjistro Shitje</h2>
                <button class="close" onclick="mbyllModal('shitje')">×</button>
            </div>
            <div class="form-group">
                <label>Data e Shitjes:</label>
                <input type="date" id="shitje-data">
                <small style="color: #86868b; font-size: 12px; margin-top: 5px; display: block;">
                    Formati: DD-MM-YYYY
                </small>
            </div>
            <div class="form-group">
                <label>Përshkrimi:</label>
                <input type="text" id="shitje-pershkrimi" list="shitje-pershkrimi-list" placeholder="p.sh. Instalim sistem fotovoltaik 10kW" autocomplete="off">
                <datalist id="shitje-pershkrimi-list">
                    <!-- Do të plotësohet me JavaScript -->
                </datalist>
            </div>
            <div class="form-group">
                <label>Shuma (MKD):</label>
                <input type="number" id="shitje-shuma" placeholder="0.00" step="0.01">
            </div>
            <button class="btn btn-success" onclick="shtoShitje()">✅ Shto Shitjen</button>
        </div>
    </div>

    <!-- Modal për Shpenzime -->
    <div id="modal-shpenzim" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🔋 Regjistro Shpenzim</h2>
                <button class="close" onclick="mbyllModal('shpenzim')">×</button>
            </div>
            <div class="form-group">
                <label>Data e Shpenzimit:</label>
                <input type="date" id="shpenzim-data">
                <small style="color: #86868b; font-size: 12px; margin-top: 5px; display: block;">
                    Formati: DD-MM-YYYY
                </small>
            </div>
            <div class="form-group">
                <label>Kategoria:</label>
                <select id="shpenzim-kategoria">
<option value="Mirembajtja e Llogarise">Mirembajtja e Llogarise</option>
<option value="Harxhim per rryme DUFERCO">Harxhim per rryme DUFERCO</option>
<option value="Harxhim per rryme EVN">Harxhim per rryme EVN</option>
<option value="Akontacion">Akontacion</option>
<option value="Tatim TVSH">Tatim TVSH</option>
<option value="Provizion per kredi">Provizion per kredi</option>
<option value="Kesti per kredi">Kesti per kredi</option>
<option value="Rroga per puntore">Rroga per puntore</option>
<option value="Rroga Zudi">Rroga Zudi</option>
<option value="Kontabilitet">Kontabilitet</option>
<option value="Sigurimi i objektit">Sigurimi i objektit</option>
<option value="Telekom internet">Telekom internet</option>
<option value="Tatim mbi pronen">Tatim mbi pronen</option>
<option value="Te tjera">Te tjera</option>
</select>
            </div>
            <div class="form-group">
                <label>Përshkrimi:</label>
                <input type="text" id="shpenzim-pershkrimi" list="shpenzim-pershkrimi-list" placeholder="Përshkrimi i shpenzimit" autocomplete="off">
                <datalist id="shpenzim-pershkrimi-list">
                    <!-- Do të plotësohet me JavaScript -->
                </datalist>
            </div>
            <div class="form-group">
                <label>Shuma (MKD):</label>
                <input type="number" id="shpenzim-shuma" placeholder="0.00" step="0.01">
            </div>
            <button class="btn btn-warning" onclick="shtoShpenzim()">✅ Shto Shpenzimin</button>
        </div>
    </div>

    <!-- Modal për Tërheqje -->
    <div id="modal-terheqje" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>💸 Regjistro Tërheqje</h2>
                <button class="close" onclick="mbyllModal('terheqje')">×</button>
            </div>
            <div class="form-group">
                <label>Data:</label>
                <input type="date" id="terheqje-data">
                <small style="color: #86868b; font-size: 12px; margin-top: 5px; display: block;">
                    Formati: DD-MM-YYYY
                </small>
            </div>
            <div class="form-group">
                <label>Ortaku:</label>
                <select id="terheqje-ortaku">
                    <option value="">Zgjidh ortakun</option>
                    <option value="Nexha">Nexha (50%)</option>
                    <option value="Gresa">Gresa (50%)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Shuma e Tërhequr (MKD):</label>
                <input type="number" id="terheqje-shuma" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
                <label>Arsyeja:</label>
                <input type="text" id="terheqje-arsyeja" list="terheqje-arsyeja-list" placeholder="p.sh. Tërheqje mujore" autocomplete="off">
                <datalist id="terheqje-arsyeja-list">
                    <!-- Do të plotësohet me JavaScript -->
                </datalist>
            </div>
            <button class="btn btn-purple" onclick="shtoTerheqje()">✅ Shto Tërheqjen</button>
        </div>
    </div>

    <!-- Modal për Investim -->
    <div id="modal-investim" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>💼 Regjistro Investim</h2>
                <button class="close" onclick="mbyllModal('investim')">×</button>
            </div>
            <div class="form-group">
                <label>Data:</label>
                <input type="date" id="investim-data">
                <small style="color: #86868b; font-size: 12px; margin-top: 5px; display: block;">
                    Formati: DD-MM-YYYY
                </small>
            </div>
            <div class="form-group">
                <label>Ortaku:</label>
                <select id="investim-ortaku">
                    <option value="">Zgjidh ortakun</option>
                    <option value="Nexha">Nexha (50%)</option>
                    <option value="Gresa">Gresa (50%)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Shuma (MKD):</label>
                <input type="number" id="investim-shuma" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
                <label>Arsyeja (opsionale):</label>
                <input type="text" id="investim-arsyeja" list="investim-arsyeja-list" placeholder="p.sh. Kapital shtesë" autocomplete="off">
                <datalist id="investim-arsyeja-list">
                    <!-- Do të plotësohet me JavaScript -->
                </datalist>
            </div>
            <button class="btn btn-success" onclick="shtoInvestim()">✅ Shto Investimin</button>
        </div>
    </div>

    <!-- Modal për Huamarrje -->
    <div id="modal-huamarrje" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🤝 Regjistro Huamarrje</h2>
                <button class="close" onclick="mbyllModal('huamarrje')">×</button>
            </div>
            <div class="form-group">
                <label>Data:</label>
                <input type="date" id="huamarrje-data">
                <small style="color: #86868b; font-size: 12px; margin-top: 5px; display: block;">
                    Formati: DD-MM-YYYY
                </small>
            </div>
            <div class="form-group">
                <label>Burimi i Huasë:</label>
                <input type="text" id="huamarrje-burimi" placeholder="p.sh. Banka, Person, etj.">
            </div>
            <div class="form-group">
                <label>Shuma e Huazuar (MKD):</label>
                <input type="number" id="huamarrje-shuma" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
                <label>Përshkrimi:</label>
                <input type="text" id="huamarrje-pershkrimi" list="huamarrje-pershkrimi-list" placeholder="p.sh. Detaje shtesë (opsionale)" autocomplete="off">
                <datalist id="huamarrje-pershkrimi-list">
                    <!-- Do të plotësohet me JavaScript -->
                </datalist>
            </div>
            <button class="btn btn-warning" onclick="shtoHuamarrje()">✅ Shto Huamarrjen</button>
        </div>
    </div>

    <!-- Modal për Kthim i Huasë -->
    <div id="modal-kthim-huase" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>💳 Kthim i Huasë</h2>
                <button class="close" onclick="mbyllModal('kthim-huase')">×</button>
            </div>
            <div class="form-group">
                <label>Data:</label>
                <input type="date" id="kthim-huase-data">
                <small style="color: #86868b; font-size: 12px; margin-top: 5px; display: block;">
                    Formati: DD-MM-YYYY
                </small>
            </div>
            <div class="form-group">
                <label>Kreditori (kujt po i ktheni):</label>
                <input type="text" id="kthim-huase-kreditori" placeholder="p.sh. Banka, Person, etj.">
            </div>
            <div class="form-group">
                <label>Shuma e Kthyer (MKD):</label>
                <input type="number" id="kthim-huase-shuma" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
                <label>Përshkrimi:</label>
                <input type="text" id="kthim-huase-pershkrimi" list="kthim-huase-pershkrimi-list" placeholder="p.sh. Detaje shtesë (opsionale)" autocomplete="off">
                <datalist id="kthim-huase-pershkrimi-list">
                    <!-- Do të plotësohet me JavaScript -->
                </datalist>
            </div>
            <button class="btn btn-danger" onclick="shtoKthimHuase()">✅ Shto Kthimin e Huasë</button>
        </div>
    </div>


    <!-- Modal për Edito Transaksion -->
    <div id="modal-edito" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="edito-title">✏️ Edito Transaksionin</h2>
                <button class="close" onclick="mbyllModal('edito')">×</button>
            </div>
            <div class="form-group">
                <label>Data:</label>
                <input type="date" id="edito-data">
                <small style="color: #86868b; font-size: 12px; margin-top: 5px; display: block;">
                    Formati: DD-MM-YYYY
                </small>
            </div>
            <div class="form-group" id="edito-kategoria-group" style="display: none;">
                <label>Kategoria:</label>
                <select id="edito-kategoria">
<option value="Mirembajtja e Llogarise">Mirembajtja e Llogarise</option>
<option value="Harxhim per rryme DUFERCO">Harxhim per rryme DUFERCO</option>
<option value="Harxhim per rryme EVN">Harxhim per rryme EVN</option>
<option value="Akontacion">Akontacion</option>
<option value="Tatim TVSH">Tatim TVSH</option>
<option value="Provizion per kredi">Provizion per kredi</option>
<option value="Kesti per kredi">Kesti per kredi</option>
<option value="Rroga per puntore">Rroga per puntore</option>
<option value="Rroga Zudi">Rroga Zudi</option>
<option value="Kontabilitet">Kontabilitet</option>
<option value="Sigurimi i objektit">Sigurimi i objektit</option>
<option value="Telekom internet">Telekom internet</option>
<option value="Tatim mbi pronen">Tatim mbi pronen</option>
<option value="Te tjera">Te tjera</option>
</select>
            </div>
            <div class="form-group" id="edito-ortaku-group" style="display: none;">
                <label>Ortaku:</label>
                <select id="edito-ortaku">
                    <option value="">Zgjidh ortakun</option>
                    <option value="Nexha">Nexha (50%)</option>
                    <option value="Gresa">Gresa (50%)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Përshkrimi:</label>
                <input type="text" id="edito-pershkrimi" placeholder="Përshkrimi i transaksionit">
            </div>
            <div class="form-group">
                <label>Shuma (MKD):</label>
                <input type="number" id="edito-shuma" placeholder="0.00" step="0.01">
            </div>
            <input type="hidden" id="edito-id">
            <input type="hidden" id="edito-tipi">
            <button class="btn btn-primary" onclick="ruajEditimin()">✅ Ruaj Ndryshimet</button>
        </div>
    </div>

    <!-- Modal për Raporte -->
    <div id="modal-raport" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h2>📅 Raporte Mujore</h2>
                <button class="close" onclick="mbyllModal('raport')">×</button>
            </div>
            
            <div class="form-group">
                <label>Zgjidhni Vitin:</label>
                <select id="viti-raport-mujor" onchange="ngarkoRaporteMujore()">
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                    <option value="2026">2026</option>
                </select>
            </div>
            
            <!-- Kartelat e Muajve -->
            <div id="monthly-cards-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 25px;">
                <!-- Do të plotësohet me JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Modal për Detajet e Muajit -->
    <div id="modal-detaje-muaji" class="modal">
        <div class="modal-content" style="max-width: 1100px;">
            <div class="modal-header">
                <h2 id="detaje-muaji-title">📅 Detajet e Muajit</h2>
                <button class="close" onclick="mbyllModal('detaje-muaji')">×</button>
            </div>
            
            <!-- Përmbledhja e Muajit -->
            <div id="muaji-summary" style="padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <!-- Do të plotësohet me JavaScript -->
            </div>
            
            <!-- Tabela me Transaksione -->
            <div style="max-height: 50vh; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 15px;">
                <table class="main-table" style="margin: 0;">
                    <thead style="position: sticky; top: 0; background: #f2f2f2; z-index: 10;">
                        <tr>
                            <th>Data</th>
                            <th>Tipi</th>
                            <th>Përshkrimi</th>
                            <th>Kategoria</th>
                            <th>Shuma</th>
                        </tr>
                    </thead>
                    <tbody id="muaji-tbody">
                        <!-- Do të plotësohet me JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-primary" onclick="eksportoMuajinNeExcel()">📄 Eksporto në Excel</button>
                <button class="btn btn-primary" onclick="printoRaportiMujor()">🖨️ Printo</button>
                <button class="btn btn-secondary" onclick="mbyllModal('detaje-muaji')">Mbyll</button>
            </div>
        </div>
    </div>

    <!-- Modal për Raporte Vjetore -->
    <div id="modal-vjetor" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📈 Raporti Vjetor</h2>
                <button class="close" onclick="mbyllModal('vjetor')">×</button>
            </div>
            <div class="form-group">
                <label>Zgjidhni Vitin:</label>
                <select id="viti-raporti">
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                    <option value="2026">2026</option>
                </select>
            </div>
            
            <!-- Përmbledhja Vjetore -->
            <div id="permbledhja-vjetore" style="margin: 20px 0;">
                <!-- Do të plotësohet me JavaScript -->
            </div>
            
            <!-- Analiza Mujore -->
            <div id="analiza-mujore" style="margin: 20px 0;">
                <!-- Do të plotësohet me JavaScript -->
            </div>
            
            <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 20px;">
                <button class="btn btn-primary" onclick="ngarkoRaportiVjetor()">📊 Ngarko Raportin</button>
                <button class="btn btn-primary" onclick="printoRaportiVjetor()">🖨️ Printo Raportin Vjetor</button>
                <button class="btn btn-primary" onclick="eksportoRaportiVjetor()">📄 Eksporto Raportin Vjetor</button>
            </div>
        </div>
    </div>

    <!-- Modal Universal për Detaje -->
    <div id="modal-detaje-universal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="universal-title">📊 Detajet</h2>
                <button class="close" onclick="mbyllModal('detaje-universal')">×</button>
            </div>
            
            <!-- Përmbledhja -->
            <div id="universal-summary" style="padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <!-- Do të plotësohet me JavaScript -->
            </div>
            
            <!-- Tabela me Detaje -->
            <div style="max-height: 50vh; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 15px;">
                <table class="main-table" style="margin: 0;">
                    <thead style="position: sticky; top: 0; background: #f2f2f2; z-index: 10;">
                        <tr id="universal-table-header">
                            <!-- Do të plotësohet me JavaScript -->
                        </tr>
                    </thead>
                    <tbody id="universal-tbody">
                        <!-- Do të plotësohet me JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-primary" onclick="eksportoDetajetUniversal()">📄 Eksporto në CSV</button>
                <button class="btn btn-secondary" onclick="mbyllModal('detaje-universal')">Mbyll</button>
            </div>
        </div>
    </div>

    <!-- Modal për Detajet e Tërheqjeve -->
    <div id="modal-detaje-terheqje" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="detaje-terheqje-title">💸 Detajet e Tërheqjeve</h2>
                <button class="close" onclick="mbyllModal('detaje-terheqje')">×</button>
            </div>
            
            <!-- Përmbledhja -->
            <div style="background: linear-gradient(135deg, rgba(147, 51, 234, 0.1), rgba(168, 85, 247, 0.1)); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #9333EA;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <div style="font-size: 0.85em; color: #86868b; margin-bottom: 5px;">TOTALI I TËRHEQUR</div>
                        <div style="font-size: 1.8em; font-weight: 700; color: #9333EA;" id="detaje-total">0.00 MKD</div>
                    </div>
                    <div>
                        <div style="font-size: 0.85em; color: #86868b; margin-bottom: 5px;">NUMRI I TËRHEQJEVE</div>
                        <div style="font-size: 1.8em; font-weight: 700; color: #9333EA;" id="detaje-count">0</div>
                    </div>
                    <div>
                        <div style="font-size: 0.85em; color: #86868b; margin-bottom: 5px;">MESATARJA PËR TËRHEQJE</div>
                        <div style="font-size: 1.8em; font-weight: 700; color: #9333EA;" id="detaje-average">0.00 MKD</div>
                    </div>
                </div>
            </div>
            
            <!-- Tabela me Detaje -->
            <div style="max-height: 50vh; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 15px;">
                <table class="main-table" style="margin: 0;">
                    <thead style="position: sticky; top: 0; background: #f2f2f2; z-index: 10;">
                        <tr>
                            <th>Data</th>
                            <th>Përshkrimi</th>
                            <th>Shuma</th>
                        </tr>
                    </thead>
                    <tbody id="detaje-terheqje-tbody">
                        <!-- Do të plotësohet me JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-primary" onclick="eksportoTerheqjet()">📄 Eksporto në CSV</button>
                <button class="btn btn-secondary" onclick="mbyllModal('detaje-terheqje')">Mbyll</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="import-file-input" accept=".json" style="display: none;" onchange="handleFileImport(event)">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // Authentication System
        const validUsers = {
            'admin': 'Zudienuz2025'
        };

        let currentUser = null;
        let monthlyChart = null;
        let transaksionet = [];
        let showAllTransactions = false; // Kontroll për shfaqjen e transaksioneve
        const INITIAL_ROWS_TO_SHOW = 10; // Numri i rreshtave fillestare

        // Google Sheets Configuration
        const GOOGLE_SHEETS_CONFIG = {
            webAppUrl: 'https://script.google.com/macros/s/AKfycbxLP1Z7dpy04IfTMqP2xdh2NXO1dKRrywk_5bti7qJ5ieYc9Gq4-RMS-jvAmzD1yEmE/exec',
            enabled: true // Set to false to use localStorage only
        };

        // Local Storage Management (Backup fallback)
        const STORAGE_KEY = 'sunenergy_transactions';
        const STORAGE_VERSION = '1.0';

        // === GOOGLE SHEETS FUNCTIONS ===
        
        // Load data from Google Sheets
        async function loadDataFromGoogleSheets() {
            if (!GOOGLE_SHEETS_CONFIG.enabled) {
                console.log('Google Sheets integration disabled');
                return false;
            }

            try {
                showStorageIndicator('info', '☁️ Duke ngarkuar nga Google Sheets...');
                
                const response = await fetch(GOOGLE_SHEETS_CONFIG.webAppUrl);
                
                if (!response.ok) {
                    throw new Error(`Apps Script error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error('Failed to load data from Apps Script');
                }
                
                if (!result.data || result.data.length === 0) {
                    console.log('No data in Google Sheets');
                    transaksionet = [];
                    showStorageIndicator('info', 'ℹ️ Nuk ka të dhëna në Google Sheets');
                    return true;
                }
                
                // Convert sheet rows to transactions
                transaksionet = result.data.map(row => {
                    let dataValue = row[1] || '';
                    
                    // Fix date if it's a timestamp
                    if (dataValue && dataValue.includes('T')) {
                        const dateObj = new Date(dataValue);
                        const day = String(dateObj.getDate()).padStart(2, '0');
                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        const year = dateObj.getFullYear();
                        dataValue = `${day}-${month}-${year}`;
                        console.log(`🔧 Fixed timestamp: ${row[1]} -> ${dataValue}`);
                    }
                    // Fix dates ONLY if second part > 12 (clearly MM-DD-YYYY)
                    else if (dataValue && dataValue.match(/^\d{2}-\d{2}-\d{4}$/)) {
                        const parts = dataValue.split('-');
                        const first = parseInt(parts[0]);
                        const second = parseInt(parts[1]);
                        
                        // Only fix if second part > 12 (clearly a month in MM-DD-YYYY format)
                        if (second > 12) {
                            dataValue = `${parts[1]}-${parts[0]}-${parts[2]}`;
                            console.log(`🔧 Fixed MM-DD (month>12): ${row[1]} -> ${dataValue}`);
                        } else {
                            // Assume DD-MM-YYYY format (correct format)
                            console.log(`✅ Already DD-MM-YYYY: ${dataValue}`);
                        }
                    }
                    
                    return {
                        id: String(row[0] || generateId()),
                        data: dataValue,
                        tipi: row[2] || '',
                        pershkrimi: row[3] || '',
                        kategoria: row[4] || '',
                        shuma: parseFloat(row[5]) || 0,
                        timestamp: row[6] || new Date().toISOString()
                    };
                });
                
                console.log('✅ Loaded from Google Sheets:', transaksionet.length, 'transactions');
                showStorageIndicator('success', `✅ ${transaksionet.length} transaksione nga Google Sheets`);
                
                // Also save to localStorage as backup
                saveDataToStorage();
                
                return true;
            } catch (error) {
                console.error('❌ Error loading from Google Sheets:', error);
                showStorageIndicator('error', '⚠️ Gabim në ngarkimin nga Google Sheets');
                
                // Fallback to localStorage
                return loadDataFromStorage();
            }
        }
        
        // Save data to Google Sheets
        async function saveDataToGoogleSheets() {
            if (!GOOGLE_SHEETS_CONFIG.enabled) {
                console.log('Google Sheets integration disabled');
                return false;
            }

            try {
                showStorageIndicator('info', '☁️ Duke ruajtur në Google Sheets...');
                
                // Prepare data to send
                const dataToSend = {
                    transactions: transaksionet.map(t => ({
                        id: t.id || generateId(),
                        data: t.data || '',
                        tipi: t.tipi || '',
                        pershkrimi: t.pershkrimi || '',
                        kategoria: t.kategoria || '',
                        shuma: t.shuma || 0,
                        timestamp: t.timestamp || new Date().toISOString()
                    }))
                };
                
                const response = await fetch(GOOGLE_SHEETS_CONFIG.webAppUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain', // Use text/plain to avoid CORS preflight
                    },
                    body: JSON.stringify(dataToSend)
                });
                
                console.log('✅ Saved to Google Sheets:', transaksionet.length, 'transactions');
                showStorageIndicator('success', '✅ Ruajtur në Google Sheets');
                
                // Also save to localStorage as backup
                saveDataToStorage();
                
                return true;
            } catch (error) {
                console.error('❌ Error saving to Google Sheets:', error);
                showStorageIndicator('error', '⚠️ Gabim në ruajtjen në Google Sheets');
                
                // Fallback to localStorage
                saveDataToStorage();
                return false;
            }
        }
        
        // Generate unique ID
        function generateId() {
            return 'txn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function saveDataToStorage() {
            try {
                const dataToSave = {
                    version: STORAGE_VERSION,
                    timestamp: new Date().toISOString(),
                    data: transaksionet
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                console.log('Data saved to localStorage:', transaksionet.length, 'transactions');
                return true;
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                return false;
            }
        }

        function loadDataFromStorage() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    if (parsedData.version === STORAGE_VERSION && parsedData.data) {
                        transaksionet = parsedData.data;
                        
                        // Convert all existing dates to DD-MM-YYYY format and ensure proper conversion
                        transaksionet = transaksionet.map(t => {
                            // Convert ID to string (for compatibility with old numeric IDs)
                            t.id = String(t.id);
                            
                            // Check if date is in YYYY-MM-DD format and convert
                            if (t.data && t.data.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                t.data = formatDateForDisplay(t.data);
                            }
                            // Check if date is in DD/MM/YYYY format and convert to DD-MM-YYYY
                            else if (t.data && t.data.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                                t.data = t.data.replace(/\//g, '-'); // Replace / with -
                            }
                            return t;
                        });
                        
                        // Save the converted data back to storage
                        saveDataToGoogleSheets();
                        
                        console.log('Data loaded and converted to DD-MM-YYYY format:', transaksionet.length, 'transactions');
                        showStorageIndicator('success', '✅ Data e konvertuar në DD-MM-YYYY');
                        return true;
                    }
                }
                console.log('No valid data found in localStorage');
                transaksionet = [];
                return false;
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                transaksionet = [];
                showStorageIndicator('error', '⚠️ Gabim në ngarkim');
                return false;
            }
        }

        function showStorageIndicator(type, message) {
            const indicator = document.getElementById('storage-indicator');
            indicator.className = `storage-indicator ${type}`;
            indicator.textContent = message;
            indicator.classList.remove('hidden');
            
            setTimeout(() => {
                indicator.classList.add('hidden');
            }, 3000);
        }

        function backupData() {
            try {
                const backupData = {
                    version: STORAGE_VERSION,
                    timestamp: new Date().toISOString(),
                    data: transaksionet,
                    summary: {
                        totalTransactions: transaksionet.length,
                        totalSales: transaksionet.filter(t => t.tipi === 'Shitje').length,
                        totalExpenses: transaksionet.filter(t => t.tipi === 'Shpenzim').length,
                        totalWithdrawals: transaksionet.filter(t => t.tipi === 'Tërheqje').length
                    }
                };

                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `sunenergy_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStorageIndicator('success', '📥 Backup i krijuar');
                alert('✅ Backup-i u krijua me sukses!\nFajli u shkarkua në kompjuterin tuaj.');
            } catch (error) {
                console.error('Error creating backup:', error);
                showStorageIndicator('error', '⚠ Gabim në backup');
                alert('⚠ Gabim në krijimin e backup-it!');
            }
        }

        function importData() {
            document.getElementById('import-file-input').click();
        }

        async function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!importedData.data || !Array.isArray(importedData.data)) {
                        alert('⚠ Format i gabuar i fajlit!');
                        return;
                    }

                    const confirmed = confirm(
                        `📥 Dëshironi të importoni ${importedData.data.length} transaksione?\n\n` +
                        `⚠️ KUJDES: Kjo do të zëvendësojë të gjitha të dhënat ekzistuese!\n\n` +
                        `Transaksionet aktuale: ${transaksionet.length}\n` +
                        `Transaksionet e reja: ${importedData.data.length}\n\n` +
                        `Klikoni OK për të vazhduar ose Cancel për të anulluar.`
                    );

                    if (confirmed) {
                        // Convert all IDs to strings for consistency
                        transaksionet = importedData.data.map(t => ({
                            ...t,
                            id: String(t.id) // Convert ID to string!
                        }));
                        
                        console.log('📥 Importuar:', transaksionet.length, 'transaksione');
                        console.log('Sample transaction:', transaksionet[0]);
                        console.log('📅 Sample dates from import:');
                        console.log('  First 5 transactions dates:', transaksionet.slice(0, 5).map(t => t.data));
                        
                        // Wait for save to complete
                        showStorageIndicator('info', '⏳ Duke ruajtur në Google Sheets...');
                        const saved = await saveDataToGoogleSheets();
                        
                        if (saved) {
                            console.log('✅ Ruajtur në Google Sheets me sukses!');
                            console.log('📅 Dates that were sent to Google Sheets:');
                            console.log('  First 5:', transaksionet.slice(0, 5).map(t => t.data));
                        } else {
                            console.warn('⚠️ Gabim në ruajtje në Google Sheets, por u ruajt në localStorage');
                        }
                        
                        updateAutocompleteSuggestions(); // Përditëso suggestions
                        
                        // Refresh everything
                        ngarkoTabelen();
                        llogaritPermbledhjen();
                        updateCharts();
                        
                        showStorageIndicator('success', '✅ Import i kryer!');
                        alert(`✅ Import-i u krye me sukses!\n${transaksionet.length} transaksione u ngarkuan dhe u ruajtën.`);
                    }
                } catch (error) {
                    console.error('Error importing data:', error);
                    showStorageIndicator('error', '⚠ Gabim në import');
                    alert('⚠ Gabim në leximin e fajlit!\nSigurohuni që fajli është backup i vlefshëm.');
                }
            };
            
            reader.readAsText(file);
            // Reset the input so the same file can be selected again
            event.target.value = '';
        }

        function handleLogin(event) {
            event.preventDefault();
            
            const submitBtn = event.target.querySelector('.login-btn');
            
            // Add loading state to button
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '🔄 Duke u kyqur...';
            submitBtn.disabled = true;
            
            // Direct login without credentials
            setTimeout(() => {
                currentUser = 'admin';
                
                // Safari-compatible login success
                const loginContainer = document.getElementById('login-container');
                
                // Safari transition
                loginContainer.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                loginContainer.style.opacity = '0';
                loginContainer.style.transform = 'scale(0.95)';
                
                // Remove body scroll lock for Safari
                document.body.classList.remove('login-active');
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.width = '';
                document.body.style.height = '';
                
                setTimeout(() => {
                    loginContainer.classList.add('hidden');
                    loginContainer.style.display = 'none'; // Force hide for Safari
                    
                    const dashboard = document.getElementById('main-dashboard');
                    dashboard.classList.remove('hidden');
                    dashboard.style.display = 'grid'; // Force show for Safari
                    
                    // Update welcome message
                    updateWelcomeMessage();
                    
                    // Initialize dashboard
                    initializeDashboard();
                }, 500);
            }, 300);
        }

        function updateWelcomeMessage() {
            const headerTitle = document.querySelector('.header h1');
            const headerSubtitle = document.querySelector('.header p');
            
            headerTitle.textContent = `Mirë se erdhe, Admin!`;
            headerSubtitle.textContent = `SUNENERGY Dashboard - ${new Date().toLocaleDateString('sq-AL')}`;
        }

        function logout() {
            if (confirm('Jeni të sigurt që doni të dilni?')) {
                currentUser = null;
                document.getElementById('main-dashboard').classList.add('hidden');
                document.getElementById('login-container').classList.remove('hidden');
                document.getElementById('login-container').style.opacity = '1';
                document.getElementById('login-container').style.transform = 'scale(1)';
            }
        }

        async function initializeDashboard() {
            console.log('Duke inicializuar dashboard-in...');
            
            // Try to load data from Google Sheets first, fallback to localStorage
            const loadedFromSheets = await loadDataFromGoogleSheets();
            
            if (!loadedFromSheets) {
                console.log('Falling back to localStorage');
                loadDataFromStorage();
            }
            
            // Initialize autocomplete suggestions
            updateAutocompleteSuggestions();
            
            // Initialize charts
            initializeCharts();
            
            // Load data and update UI
            ngarkoTabelen();
            llogaritPermbledhjen();
            updateCharts();
            
            console.log('Dashboard-i u inicializua me sukses!');
        }
        
        // Funksioni për të përditësuar autocomplete suggestions
        function updateAutocompleteSuggestions() {
            // 1. Shitje - Përshkrime unike
            const shitjePershkrime = [...new Set(
                transaksionet
                    .filter(t => t.tipi === 'Shitje' && t.pershkrimi)
                    .map(t => t.pershkrimi)
            )].sort();
            
            const shitjeList = document.getElementById('shitje-pershkrimi-list');
            shitjeList.innerHTML = shitjePershkrime.map(p => `<option value="${p}">`).join('');
            
            // 2. Shpenzime - Përshkrime unike
            const shpenzimePershkrime = [...new Set(
                transaksionet
                    .filter(t => t.tipi === 'Shpenzim' && t.pershkrimi)
                    .map(t => t.pershkrimi)
            )].sort();
            
            const shpenzimiList = document.getElementById('shpenzim-pershkrimi-list');
            shpenzimiList.innerHTML = shpenzimePershkrime.map(p => `<option value="${p}">`).join('');
            
            // 3. Tërheqje - Arsyet unike
            const terheqjeArsye = [...new Set(
                transaksionet
                    .filter(t => t.tipi === 'Tërheqje' && t.pershkrimi)
                    .map(t => t.pershkrimi)
            )].sort();
            
            const terheqjeList = document.getElementById('terheqje-arsyeja-list');
            terheqjeList.innerHTML = terheqjeArsye.map(p => `<option value="${p}">`).join('');
            
            // 4. Investim - Arsyet unike
            const investimArsye = [...new Set(
                transaksionet
                    .filter(t => t.tipi === 'Investim' && t.pershkrimi)
                    .map(t => t.pershkrimi)
            )].sort();
            
            const investimList = document.getElementById('investim-arsyeja-list');
            investimList.innerHTML = investimArsye.map(p => `<option value="${p}">`).join('');
            
            // 5. Huamarrje - Përshkrime unike
            const huamarrjePershkrime = [...new Set(
                transaksionet
                    .filter(t => t.tipi === 'Huamarrje' && t.pershkrimi)
                    .map(t => t.pershkrimi)
            )].sort();
            
            const huamarrjeList = document.getElementById('huamarrje-pershkrimi-list');
            huamarrjeList.innerHTML = huamarrjePershkrime.map(p => `<option value="${p}">`).join('');
            
            // 6. Kthim i Huasë - Përshkrime unike
            const kthimHuasePershkrime = [...new Set(
                transaksionet
                    .filter(t => t.tipi === 'Kthim i Huasë' && t.pershkrimi)
                    .map(t => t.pershkrimi)
            )].sort();
            
            const kthimHuaseList = document.getElementById('kthim-huase-pershkrimi-list');
            kthimHuaseList.innerHTML = kthimHuasePershkrime.map(p => `<option value="${p}">`).join('');
            
            console.log('✅ Autocomplete suggestions u ngarkuan!');
        }

        // Modal functions
        function hapModal(tipi) {
            document.getElementById('modal-' + tipi).style.display = 'block';
            const today = new Date();
            const dd = String(today.getDate()).padStart(2, '0');
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const yyyy = today.getFullYear();
            
            // Set date in DD-MM-YYYY format for display, but YYYY-MM-DD for input
            const todayForInput = `${yyyy}-${mm}-${dd}`;
            const todayForDisplay = `${dd}-${mm}-${yyyy}`;
            
            if (document.getElementById(tipi + '-data')) {
                document.getElementById(tipi + '-data').value = todayForInput;
                // Add a data attribute to show what format we want
                document.getElementById(tipi + '-data').setAttribute('data-display-format', todayForDisplay);
            }
            
            // Ngarko raportet mujore kur hapet modali
            if (tipi === 'raport') {
                ngarkoRaporteMujore();
            }
        }

        function mbyllModal(tipi) {
            document.getElementById('modal-' + tipi).style.display = 'none';
            if (tipi !== 'raport' && tipi !== 'vjetor' && tipi !== 'detaje-muaji') {
                pastroForm(tipi);
            }
        }

        function pastroForm(tipi) {
            const modal = document.getElementById('modal-' + tipi);
            if (!modal) return;
            
            const inputs = modal.querySelectorAll('input, select');
            inputs.forEach(input => {
                if (input.type !== 'date') {
                    input.value = '';
                }
            });
            
            // Reset visibility for edit modal
            if (tipi === 'edito') {
                document.getElementById('edito-kategoria-group').style.display = 'none';
                document.getElementById('edito-ortaku-group').style.display = 'none';
            }
        }

        // Add sale
        async function shtoShitje() {
            const data = document.getElementById('shitje-data').value;
            const pershkrimi = document.getElementById('shitje-pershkrimi').value;
            const shuma = parseFloat(document.getElementById('shitje-shuma').value);

            if (!data || !pershkrimi || !shuma || isNaN(shuma)) {
                alert('Ju lutem plotësoni të gjitha fushat me vlera të sakta!');
                return;
            }

            const transaksioni = {
                id: generateId(),
                data: formatDateForDisplay(data),
                tipi: 'Shitje',
                pershkrimi: pershkrimi,
                kategoria: 'Shitje',
                shuma: shuma,
                timestamp: new Date().toISOString()
            };

            transaksionet.push(transaksioni);
            
            // Save to Google Sheets (async)
            await saveDataToGoogleSheets();
                updateAutocompleteSuggestions(); // Përditëso suggestions
                ngarkoTabelen();
                llogaritPermbledhjen();
                updateCharts();
                mbyllModal('shitje');
                alert('Shitja u shtua me sukses!');
        }

        // Add expense
        async function shtoShpenzim() {
            const data = document.getElementById('shpenzim-data').value;
            const kategoria = document.getElementById('shpenzim-kategoria').value;
            const pershkrimi = document.getElementById('shpenzim-pershkrimi').value;
            const shuma = parseFloat(document.getElementById('shpenzim-shuma').value);

            if (!data || !kategoria || !pershkrimi || !shuma || isNaN(shuma)) {
                alert('Ju lutem plotësoni të gjitha fushat me vlera të sakta!');
                return;
            }

            const transaksioni = {
                id: generateId(),
                data: formatDateForDisplay(data),
                tipi: 'Shpenzim',
                pershkrimi: pershkrimi,
                kategoria: kategoria,
                shuma: -shuma,
                timestamp: new Date().toISOString()
            };

            transaksionet.push(transaksioni);
            saveDataToGoogleSheets();
            updateAutocompleteSuggestions(); // Përditëso suggestions
            ngarkoTabelen();
            llogaritPermbledhjen();
            updateCharts();
            mbyllModal('shpenzim');
            
            alert('Shpenzimi u shtua me sukses!');
        }

        // Add withdrawal
        async function shtoTerheqje() {
            const data = document.getElementById('terheqje-data').value;
            const ortaku = document.getElementById('terheqje-ortaku').value;
            const shuma = parseFloat(document.getElementById('terheqje-shuma').value);
            const arsyeja = document.getElementById('terheqje-arsyeja').value;

            if (!data || !ortaku || !shuma || !arsyeja || isNaN(shuma)) {
                alert('Ju lutem plotësoni të gjitha fushat me vlera të sakta!');
                return;
            }

            const transaksioni = {
                id: generateId(),
                data: formatDateForDisplay(data),
                tipi: 'Tërheqje',
                pershkrimi: arsyeja,
                kategoria: ortaku,
                shuma: -shuma,
                timestamp: new Date().toISOString()
            };

            transaksionet.push(transaksioni);
            saveDataToGoogleSheets();
            updateAutocompleteSuggestions(); // Përditëso suggestions
            ngarkoTabelen();
            llogaritPermbledhjen();
            updateCharts();
            mbyllModal('terheqje');
            
            alert('Tërheqja u shtua me sukses!');
        }

        // Edit transaction
        
        // Shto Investim (hyrje pozitive)
        async function shtoInvestim() {
            const data = document.getElementById('investim-data').value;
            const ortaku = document.getElementById('investim-ortaku').value;
            const shuma = parseFloat(document.getElementById('investim-shuma').value);
            const arsyeja = document.getElementById('investim-arsyeja').value || '';

            if (!data || !ortaku || !shuma || isNaN(shuma)) {
                alert('Ju lutem plotësoni fushat: Data, Ortaku dhe Shuma me vlera të sakta!');
                return;
            }

            const transaksioni = {
                id: generateId(),
                data: formatDateForDisplay(data),
                tipi: 'Investim',
                pershkrimi: arsyeja,
                kategoria: ortaku,
                shuma: shuma,
                timestamp: new Date().toISOString()
            };

            transaksionet.push(transaksioni);
            saveDataToGoogleSheets();
            updateAutocompleteSuggestions(); // Përditëso suggestions
            ngarkoTabelen();
            llogaritPermbledhjen();
            updateCharts();
            mbyllModal('investim');
            alert('Investimi u shtua me sukses!');
        }

        // Shto Huamarrje (hyrje pozitive - para që hyjnë)
        async function shtoHuamarrje() {
            console.log('shtoHuamarrje u thirr!');
            
            const data = document.getElementById('huamarrje-data').value;
            const burimi = document.getElementById('huamarrje-burimi').value.trim();
            const shuma = parseFloat(document.getElementById('huamarrje-shuma').value);
            const pershkrimi = document.getElementById('huamarrje-pershkrimi').value.trim();

            console.log('Vlerat:', { data, burimi, shuma, pershkrimi });

            // Validim bazik
            if (!data) {
                alert('Ju lutem zgjidhni datën!');
                return;
            }
            
            if (!burimi) {
                alert('Ju lutem vendosni burimin e huasë!');
                return;
            }
            
            if (!shuma || isNaN(shuma) || shuma <= 0) {
                alert('Ju lutem vendosni një shumë të vlefshme!');
                return;
            }

            const transaksioni = {
                id: generateId(),
                data: formatDateForDisplay(data),
                tipi: 'Huamarrje',
                pershkrimi: pershkrimi || burimi,
                kategoria: burimi,
                shuma: shuma, // Shuma pozitive - para që hyjnë në kompani
                timestamp: new Date().toISOString()
            };

            console.log('Transaksioni i krijuar:', transaksioni);

            transaksionet.push(transaksioni);
            saveDataToGoogleSheets();
            updateAutocompleteSuggestions(); // Përditëso suggestions
            ngarkoTabelen();
            llogaritPermbledhjen();
            updateCharts();
            mbyllModal('huamarrje');
            alert('✅ Huamarrja u shtua me sukses!');
        }

        // Shto Kthim i Huasë (dalje negative - para që dalin)
        async function shtoKthimHuase() {
            console.log('shtoKthimHuase u thirr!');
            
            const data = document.getElementById('kthim-huase-data').value;
            const kreditori = document.getElementById('kthim-huase-kreditori').value.trim();
            const shuma = parseFloat(document.getElementById('kthim-huase-shuma').value);
            const pershkrimi = document.getElementById('kthim-huase-pershkrimi').value.trim();

            console.log('Vlerat:', { data, kreditori, shuma, pershkrimi });

            // Validim bazik
            if (!data) {
                alert('Ju lutem zgjidhni datën!');
                return;
            }
            
            if (!kreditori) {
                alert('Ju lutem vendosni kreditorin!');
                return;
            }
            
            if (!shuma || isNaN(shuma) || shuma <= 0) {
                alert('Ju lutem vendosni një shumë të vlefshme!');
                return;
            }

            const transaksioni = {
                id: generateId(),
                data: formatDateForDisplay(data),
                tipi: 'Kthim i Huasë',
                pershkrimi: pershkrimi || kreditori,
                kategoria: kreditori,
                shuma: -shuma, // Shuma negative - para që dalin nga kompania
                timestamp: new Date().toISOString()
            };

            console.log('Transaksioni i krijuar:', transaksioni);

            transaksionet.push(transaksioni);
            saveDataToGoogleSheets();
            updateAutocompleteSuggestions(); // Përditëso suggestions
            ngarkoTabelen();
            llogaritPermbledhjen();
            updateCharts();
            mbyllModal('kthim-huase');
            alert('✅ Kthimi i huasë u shtua me sukses!');
        }

function editoTransaksionin(id) {
            const transaksioni = transaksionet.find(t => t.id === id);
            if (!transaksioni) {
                alert('Transaksioni nuk u gjet!');
                return;
            }

            // Populate the form
            document.getElementById('edito-id').value = transaksioni.id;
            document.getElementById('edito-tipi').value = transaksioni.tipi;
            document.getElementById('edito-data').value = formatDateForInput(transaksioni.data);
            document.getElementById('edito-pershkrimi').value = transaksioni.pershkrimi;
            
            // Set the amount (always positive in the form)
            const shumaValue = Math.abs(transaksioni.shuma);
            document.getElementById('edito-shuma').value = shumaValue;

            // Show/hide relevant fields based on transaction type
            const kategoriGroup = document.getElementById('edito-kategoria-group');
            const ortakuGroup = document.getElementById('edito-ortaku-group');
            const kategoriSelect = document.getElementById('edito-kategoria');
            const ortakuSelect = document.getElementById('edito-ortaku');

            // Reset visibility
            kategoriGroup.style.display = 'none';
            ortakuGroup.style.display = 'none';

            if (transaksioni.tipi === 'Shpenzim') {
                kategoriGroup.style.display = 'block';
                kategoriSelect.value = transaksioni.kategoria;
            } else if (transaksioni.tipi === 'Tërheqje' || transaksioni.tipi === 'Investim') {
                ortakuGroup.style.display = 'block';
                ortakuSelect.value = transaksioni.kategoria;
            }

            // Update modal title
            const emoji = transaksioni.tipi === 'Shitje' ? '💰' : 
                         transaksioni.tipi === 'Shpenzim' ? '🔋' : 
                         transaksioni.tipi === 'Tërheqje' ? '💸' : 
                         transaksioni.tipi === 'Huamarrje' ? '🤝' : 
                         transaksioni.tipi === 'Kthim i Huasë' ? '💳' : '💼';
            const title = document.getElementById('edito-title');
            title.textContent = `✏️ Edito ${emoji} ${transaksioni.tipi}`;

            // Open modal
            document.getElementById('modal-edito').style.display = 'block';
        }

        // Date formatting functions
        function formatDateForDisplay(dateInput) {
            // Handle different input formats and always return DD-MM-YYYY
            
            // If already in DD-MM-YYYY format (e.g. from backup), return as-is
            if (/^\d{2}-\d{2}-\d{4}$/.test(dateInput)) {
                return dateInput;
            }
            
            // If in YYYY-MM-DD format (from date input), convert to DD-MM-YYYY
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateInput)) {
                const parts = dateInput.split('-');
                return `${parts[2]}-${parts[1]}-${parts[0]}`; // DD-MM-YYYY
            }
            
            // If in MM/DD/YYYY or other slash format
            if (dateInput.includes('/')) {
                const parts = dateInput.split('/');
                if (parts.length === 3) {
                    // Assume MM/DD/YYYY and convert to DD-MM-YYYY
                    return `${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}-${parts[2]}`;
                }
            }
            
            // Fallback - return as-is
            return dateInput;
        }

        function formatDateForInput(dateDisplay) {
            // Convert from DD-MM-YYYY (display format) to YYYY-MM-DD (input format)
            const parts = dateDisplay.split('-');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1]}-${parts[0]}`;
            }
            return dateDisplay;
        }

        function parseDisplayDate(dateDisplay) {
            // Convert DD-MM-YYYY to Date object for sorting
            const parts = dateDisplay.split('-');
            if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // Month is 0-indexed in Date
                const year = parseInt(parts[2]);
                return new Date(year, month, day);
            }
            // Fallback for other formats
            return new Date(dateDisplay);
        }

        // Helper function to check if date belongs to specific month
        function isDateInMonth(dateStr, monthYear) {
            // dateStr is in DD-MM-YYYY format
            // monthYear is in YYYY-MM format
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                const transactionMonthYear = `${parts[2]}-${parts[1]}`;
                return transactionMonthYear === monthYear;
            }
            return false;
        }

        // Helper function to check if date belongs to specific year
        function isDateInYear(dateStr, year) {
            // dateStr is in DD-MM-YYYY format
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                return parts[2] === year;
            }
            return false;
        }

        // Save edited transaction
        async function ruajEditimin() {

            const id = document.getElementById('edito-id').value; // Keep as string, don't parse!
            const tipi = document.getElementById('edito-tipi').value;
            const data = document.getElementById('edito-data').value;
            const pershkrimi = document.getElementById('edito-pershkrimi').value;
            const shuma = parseFloat(document.getElementById('edito-shuma').value);

            if (!data || !pershkrimi || !shuma || isNaN(shuma)) {
                alert('Ju lutem plotësoni të gjitha fushat me vlera të sakta!');
                return;
            }

            // Gjej transaksionin
            const transaksioni = transaksionet.find(t => t.id === id);
            if (!transaksioni) {
                alert('Transaksioni nuk u gjet!');
                return;
            }

            // Vendos kategoria sipas fushave të dukshme
            let kategoria = transaksioni.kategoria || '';
            const kategoriGroup = document.getElementById('edito-kategoria-group');
            const ortakuGroup = document.getElementById('edito-ortaku-group');
            if (kategoriGroup && kategoriGroup.style.display === 'block') {
                const sel = document.getElementById('edito-kategoria');
                if (sel) kategoria = sel.value;
            } else if (ortakuGroup && ortakuGroup.style.display === 'block') {
                const selO = document.getElementById('edito-ortaku');
                if (selO) kategoria = selO.value;
            }

            // Përditëso fushat
            transaksioni.data = formatDateForDisplay(data);
            transaksioni.pershkrimi = pershkrimi;
            transaksioni.kategoria = kategoria;

            // Shenja e shumës sipas tipit
            if (tipi === 'Shitje' || tipi === 'Investim' || tipi === 'Huamarrje') {
                transaksioni.shuma = shuma;
            } else if (tipi === 'Shpenzim' || tipi === 'Tërheqje' || tipi === 'Kthim i Huasë') {
                transaksioni.shuma = -shuma;
            }

            // Ruaj në Google Sheets
            await saveDataToGoogleSheets();
            console.log('✅ Transaksioni u përditësua dhe u ruajt në Google Sheets');
            
            // Përditëso UI
            ngarkoTabelen();
            llogaritPermbledhjen();
            updateCharts();
            mbyllModal('edito');
            alert('Transaksioni u përditësua me sukses!');

}

        // Load table
        function ngarkoTabelen() {
            const tabela = document.getElementById('tabela-kryesore');
            
            if (transaksionet.length === 0) {
                tabela.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <h3>🌟 Mirë se vini në SUNENERGY Dashboard!</h3>
                            <p>Përdorni menunë në të majtë për të filluar regjistrimin e transaksioneve.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // Sort by date (newest first) - make sure we parse DD-MM-YYYY correctly
            const transaksionetRenditura = [...transaksionet].sort((a, b) => {
                const dateA = parseDisplayDate(a.data);
                const dateB = parseDisplayDate(b.data);
                return dateB.getTime() - dateA.getTime(); // Newest first
            });
            
            console.log('Rendering transactions in order:', transaksionetRenditura.map(t => t.data));
            
            // Përcakto sa transaksione të shfaqen
            const transaksionePershfaqje = showAllTransactions ? 
                transaksionetRenditura : 
                transaksionetRenditura.slice(0, INITIAL_ROWS_TO_SHOW);
            
            tabela.innerHTML = '';
            transaksionePershfaqje.forEach(t => {
                const rreshti = document.createElement('tr');
                
                let klasa = '';
                if (t.tipi === 'Shitje') klasa = 'tip-shitje';
                else if (t.tipi === 'Shpenzim') klasa = 'tip-shpenzim';
                else if (t.tipi === 'Tërheqje') klasa = 'tip-terheqje';
                else if (t.tipi === 'Huamarrje') klasa = 'tip-huamarrje';
                else if (t.tipi === 'Kthim i Huasë') klasa = 'tip-kthim-huase';
                
                rreshti.className = klasa;
                
                // Shfaq shumën me emoji dhe ngjyrë
                const shumaText = t.shuma >= 0 ? 
                    `+${t.shuma.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD` : 
                    `-${Math.abs(t.shuma).toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD`;
                
                const emoji = t.tipi === 'Shitje' ? '💰' : 
                            t.tipi === 'Shpenzim' ? '🔋' : 
                            t.tipi === 'Investim' ? '💼' : 
                            t.tipi === 'Huamarrje' ? '🤝' :
                            t.tipi === 'Kthim i Huasë' ? '💳' : '💸';
                
                const shumaColor = t.shuma >= 0 ? '#34C759' : '#FF3B30';
                
                // Fix date format if it's a timestamp
                let displayDate = t.data;
                if (displayDate && displayDate.includes('T')) {
                    // It's an ISO timestamp, convert to DD-MM-YYYY
                    const dateObj = new Date(displayDate);
                    const day = String(dateObj.getDate()).padStart(2, '0');
                    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const year = dateObj.getFullYear();
                    displayDate = `${day}-${month}-${year}`;
                }
                
                rreshti.innerHTML = `
                    <td>${displayDate}</td>
                    <td>${emoji} ${t.tipi}</td>
                    <td>${t.pershkrimi}</td>
                    <td>${t.kategoria}</td>
                    <td style="font-weight: 600; color: ${shumaColor}">${shumaText}</td>
                    <td style="position: relative; z-index: 10;">
                        <div style="display: flex; gap: 6px; justify-content: center;">
                            <button onclick="editoTransaksionin('${t.id}')" 
                                    style="background: #007AFF; color: white; border: none; padding: 6px 14px; 
                                           border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer;
                                           transition: all 0.2s; display: inline-flex; align-items: center; gap: 4px;
                                           box-shadow: 0 1px 3px rgba(0, 122, 255, 0.2);"
                                    onmouseover="this.style.background='#0051D5'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 6px rgba(0, 122, 255, 0.3)';"
                                    onmouseout="this.style.background='#007AFF'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0, 122, 255, 0.2)';">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                                Edito
                            </button>
                            <button onclick="fshijTransaksionin('${t.id}')" 
                                    style="background: #FF3B30; color: white; border: none; padding: 6px 14px;
                                           border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer;
                                           transition: all 0.2s; display: inline-flex; align-items: center; gap: 4px;
                                           box-shadow: 0 1px 3px rgba(255, 59, 48, 0.2);"
                                    onmouseover="this.style.background='#D92A1F'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 2px 6px rgba(255, 59, 48, 0.3)';"
                                    onmouseout="this.style.background='#FF3B30'; this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(255, 59, 48, 0.2)';">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                                Fshij
                            </button>
                        </div>
                    </td>
                `;
                
                tabela.appendChild(rreshti);
            });
            
            // Shto butonin "Shfaq më shumë" nëse ka më shumë se 10 transaksione
            if (transaksionetRenditura.length > INITIAL_ROWS_TO_SHOW && !showAllTransactions) {
                const expandRow = document.createElement('tr');
                expandRow.id = 'expand-row';
                expandRow.innerHTML = `
                    <td colspan="6" style="text-align: center; padding: 20px; background: rgba(102, 126, 234, 0.05);">
                        <button onclick="toggleShowAllTransactions()" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">
                            📊 Shfaq të gjitha transaksionet (${transaksionetRenditura.length - INITIAL_ROWS_TO_SHOW} të tjera)
                        </button>
                    </td>
                `;
                tabela.appendChild(expandRow);
            } else if (showAllTransactions && transaksionetRenditura.length > INITIAL_ROWS_TO_SHOW) {
                // Shto butonin "Fshih" kur janë shfaqur të gjitha
                const collapseRow = document.createElement('tr');
                collapseRow.id = 'collapse-row';
                collapseRow.innerHTML = `
                    <td colspan="6" style="text-align: center; padding: 20px; background: rgba(102, 126, 234, 0.05);">
                        <button onclick="toggleShowAllTransactions()" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">
                            🔼 Fshih transaksionet e vjetra (shfaq vetëm ${INITIAL_ROWS_TO_SHOW})
                        </button>
                    </td>
                `;
                tabela.appendChild(collapseRow);
            }
        }
        
        // Toggle për shfaqjen e të gjitha transaksioneve
        function toggleShowAllTransactions() {
            showAllTransactions = !showAllTransactions;
            ngarkoTabelen();
            
            // Scroll tek tabela nëse po fsheh
            if (!showAllTransactions) {
                document.querySelector('.table-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Delete transaction
        async function fshijTransaksionin(id) {
            if (confirm('Jeni të sigurt që dëshironi të fshini këtë transaksion?')) {
                transaksionet = transaksionet.filter(t => t.id !== id);
                
                // Ruaj në Google Sheets (async në background)
                await saveDataToGoogleSheets();
                console.log('✅ Transaksioni u fshi dhe u ruajt në Google Sheets');
                
                // Përditëso UI menjëherë
                ngarkoTabelen();
                llogaritPermbledhjen();
                updateCharts();
            }
        }

        // Calculate summary
        function llogaritPermbledhjen() {
            const shitjet = transaksionet.filter(t => t.tipi === 'Shitje');
            const shpenzimet = transaksionet.filter(t => t.tipi === 'Shpenzim');
            const huamarrjet = transaksionet.filter(t => t.tipi === 'Huamarrje');
            const kthimeHuase = transaksionet.filter(t => t.tipi === 'Kthim i Huasë');
            
            const investimet = transaksionet.filter(t => t.tipi === 'Investim');
            const terheqjet = transaksionet.filter(t => t.tipi === 'Tërheqje');
            
            // TOTALET OPERATIVE
            const totalShitje = shitjet.reduce((s,t)=>s+t.shuma,0);
            const totalShpenzime = Math.abs(shpenzimet.reduce((s,t)=>s+t.shuma,0));
            const totalInvestime = investimet.reduce((s,t)=>s+t.shuma,0);
            
            // Fitimi Bruto = Shitje - Shpenzime (pa investime, pa huamarrje)
            const fitimiBruto = totalShitje - totalShpenzime;
            
            // PJESËT E ORTAKËVE (nga fitimi bruto)
            const totalTerheqje = Math.abs(terheqjet.reduce((s,t)=>s+t.shuma,0));
            const terheqjeNexha = Math.abs(terheqjet.filter(t => t.kategoria === 'Nexha').reduce((sum, t) => sum + t.shuma, 0));
            const terheqjeGresa = Math.abs(terheqjet.filter(t => t.kategoria === 'Gresa').reduce((sum, t) => sum + t.shuma, 0));
            const investimeNexha = investimet.filter(t => t.kategoria === 'Nexha').reduce((sum,t)=>sum+t.shuma,0);
            const investimeGresa = investimet.filter(t => t.kategoria === 'Gresa').reduce((sum,t)=>sum+t.shuma,0);
            
            const pjesaNexha = (fitimiBruto/2) - terheqjeNexha + investimeNexha;
            const pjesaGresa = (fitimiBruto/2) - terheqjeGresa + investimeGresa;

            // Përditëso kartat
            document.getElementById('total-shitje').textContent = `${totalShitje.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD`;
            document.getElementById('total-shpenzime').textContent = `${totalShpenzime.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD`;
            document.getElementById('fitimi-bruto').textContent = `${fitimiBruto.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD`;
            document.getElementById('pjesa-nexha').textContent = `${pjesaNexha.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD`;
            document.getElementById('pjesa-gresa').textContent = `${pjesaGresa.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD`;
            
            // Përditëso kartat e tërheqjeve
            if (document.getElementById('terheqjet-nexha')) {
                document.getElementById('terheqjet-nexha').textContent = `${terheqjeNexha.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD`;
            }
            if (document.getElementById('terheqjet-gresa')) {
                document.getElementById('terheqjet-gresa').textContent = `${terheqjeGresa.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD`;
            }
        }

        // Funksioni për të shfaqur detajet e tërheqjeve
        function shfaqDetajeTerheqje(ortaku) {
            const terheqjet = transaksionet.filter(t => 
                t.tipi === 'Tërheqje' && t.kategoria === ortaku
            );
            
            // Sort by date (newest first)
            terheqjet.sort((a, b) => parseDisplayDate(b.data) - parseDisplayDate(a.data));
            
            // Llogarit statistikat
            const total = terheqjet.reduce((sum, t) => sum + Math.abs(t.shuma), 0);
            const count = terheqjet.length;
            const average = count > 0 ? total / count : 0;
            
            // Përditëso titullin
            document.getElementById('detaje-terheqje-title').textContent = `💸 Tërheqjet e ${ortaku}`;
            
            // Përditëso statistikat
            document.getElementById('detaje-total').textContent = `${total.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD`;
            document.getElementById('detaje-count').textContent = count;
            document.getElementById('detaje-average').textContent = `${average.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD`;
            
            // Krijo tabelën
            const tbody = document.getElementById('detaje-terheqje-tbody');
            tbody.innerHTML = '';
            
            if (terheqjet.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align: center; padding: 40px; color: #86868b;">
                            <div style="font-size: 3em; margin-bottom: 10px;">📭</div>
                            <div style="font-size: 1.2em;">Nuk ka tërheqje të regjistruara për ${ortaku}</div>
                        </td>
                    </tr>
                `;
            } else {
                terheqjet.forEach(t => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${t.data}</td>
                        <td>${t.pershkrimi}</td>
                        <td style="color: #9333EA; font-weight: 600;">
                            ${Math.abs(t.shuma).toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            // Ruaj ortakun për eksport
            window.currentOrtaku = ortaku;
            
            // Hap modalin
            document.getElementById('modal-detaje-terheqje').style.display = 'block';
        }
        
        // Funksioni për eksportimin e tërheqjeve në CSV
        function eksportoTerheqjet() {
            const ortaku = window.currentOrtaku || 'Ortaku';
            const terheqjet = transaksionet.filter(t => 
                t.tipi === 'Tërheqje' && t.kategoria === ortaku
            );
            
            if (terheqjet.length === 0) {
                alert('⚠️ Nuk ka tërheqje për të eksportuar!');
                return;
            }
            
            // Sort by date (newest first)
            terheqjet.sort((a, b) => parseDisplayDate(b.data) - parseDisplayDate(a.data));
            
            // Krijo CSV
            let csvContent = `Tërheqjet e ${ortaku}\n\n`;
            csvContent += 'Data,Përshkrimi,Shuma (MKD)\n';
            
            terheqjet.forEach(t => {
                csvContent += `${t.data},"${t.pershkrimi}","${Math.abs(t.shuma).toLocaleString('mk-MK', {minimumFractionDigits: 2})}"\n`;
            });
            
            // Shto totalin
            const total = terheqjet.reduce((sum, t) => sum + Math.abs(t.shuma), 0);
            csvContent += `\nTOTALI,"","${total.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD"\n`;
            
            // Shkarko
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Terheqjet_${ortaku}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`✅ Tërheqjet e ${ortaku} u eksportuan me sukses!`);
        }

        // === FUNKSIONET PËR TË GJITHA KARTELAT CLICKABLE ===
        
        // Variabël globale për eksport
        window.currentCardData = { title: '', data: [] };
        
        // 1. DETAJET E SHITJEVE
        function shfaqDetajeShitje() {
            const shitjet = transaksionet.filter(t => t.tipi === 'Shitje');
            shitjet.sort((a, b) => parseDisplayDate(b.data) - parseDisplayDate(a.data));
            
            const total = shitjet.reduce((sum, t) => sum + t.shuma, 0);
            const count = shitjet.length;
            const average = count > 0 ? total / count : 0;
            
            shfaqModalUniversal(
                '💰 Detajet e Shitjeve',
                '#34C759',
                [
                    { label: 'TOTALI I SHITJEVE', value: `${total.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD` },
                    { label: 'NUMRI I SHITJEVE', value: count },
                    { label: 'MESATARJA PËR SHITJE', value: `${average.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD` }
                ],
                ['Data', 'Përshkrimi', 'Shuma'],
                shitjet.map(t => [
                    t.data,
                    t.pershkrimi,
                    `<span style="color: #34C759; font-weight: 600;">${t.shuma.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</span>`
                ]),
                'Shitjet'
            );
        }
        
        // 2. DETAJET E SHPENZIMEVE
        function shfaqDetajeShpenzime() {
            const shpenzimet = transaksionet.filter(t => t.tipi === 'Shpenzim');
            shpenzimet.sort((a, b) => parseDisplayDate(b.data) - parseDisplayDate(a.data));
            
            const total = shpenzimet.reduce((sum, t) => sum + Math.abs(t.shuma), 0);
            const count = shpenzimet.length;
            const average = count > 0 ? total / count : 0;
            
            shfaqModalUniversal(
                '🔋 Detajet e Shpenzimeve',
                '#FF3B30',
                [
                    { label: 'TOTALI I SHPENZIMEVE', value: `${total.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD` },
                    { label: 'NUMRI I SHPENZIMEVE', value: count },
                    { label: 'MESATARJA PËR SHPENZIM', value: `${average.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD` }
                ],
                ['Data', 'Kategoria', 'Përshkrimi', 'Shuma'],
                shpenzimet.map(t => [
                    t.data,
                    t.kategoria,
                    t.pershkrimi,
                    `<span style="color: #FF3B30; font-weight: 600;">${Math.abs(t.shuma).toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</span>`
                ]),
                'Shpenzimet'
            );
        }
        
        // 3. DETAJET E FITIMIT
        function shfaqDetajeFitimi() {
            const shitjet = transaksionet.filter(t => t.tipi === 'Shitje');
            const shpenzimet = transaksionet.filter(t => t.tipi === 'Shpenzim');
            
            const totalShitje = shitjet.reduce((sum, t) => sum + t.shuma, 0);
            const totalShpenzime = shpenzimet.reduce((sum, t) => sum + Math.abs(t.shuma), 0);
            const fitimi = totalShitje - totalShpenzime;
            const profitMargin = totalShitje > 0 ? (fitimi / totalShitje) * 100 : 0;
            
            // Përcaktimi i ngjyrës bazuar në fitim
            const color = fitimi >= 0 ? '#3B82F6' : '#FF3B30';
            
            shfaqModalUniversal(
                '📊 Analiza e Fitimit Bruto',
                color,
                [
                    { label: 'FITIMI BRUTO', value: `${fitimi.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD` },
                    { label: 'TOTALI I SHITJEVE', value: `${totalShitje.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD` },
                    { label: 'TOTALI I SHPENZIMEVE', value: `${totalShpenzime.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD` },
                    { label: 'PROFIT MARGIN', value: `${profitMargin.toFixed(2)}%` }
                ],
                ['Përshkrimi', 'Shuma'],
                [
                    ['Totali i Shitjeve', `<span style="color: #34C759; font-weight: 600;">+${totalShitje.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</span>`],
                    ['Totali i Shpenzimeve', `<span style="color: #FF3B30; font-weight: 600;">-${totalShpenzime.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</span>`],
                    ['Fitimi Bruto', `<span style="color: ${color}; font-weight: 700; font-size: 1.2em;">${fitimi >= 0 ? '+' : ''}${fitimi.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</span>`]
                ],
                'Fitimi_Bruto'
            );
        }
        
        // 7. DETAJET E PJESËS SË NEXHA
        function shfaqDetajePjesaNexha() {
            shfaqDetajePjesaOrtaku('Nexha');
        }
        
        // 8. DETAJET E PJESËS SË GRESA
        function shfaqDetajePjesaGresa() {
            shfaqDetajePjesaOrtaku('Gresa');
        }
        
        function shfaqDetajePjesaOrtaku(ortaku) {
            const shitjet = transaksionet.filter(t => t.tipi === 'Shitje');
            const shpenzimet = transaksionet.filter(t => t.tipi === 'Shpenzim');
            const terheqjet = transaksionet.filter(t => t.tipi === 'Tërheqje' && t.kategoria === ortaku);
            const investimet = transaksionet.filter(t => t.tipi === 'Investim' && t.kategoria === ortaku);
            
            const totalShitje = shitjet.reduce((sum, t) => sum + t.shuma, 0);
            const totalShpenzime = shpenzimet.reduce((sum, t) => sum + Math.abs(t.shuma), 0);
            const fitimiBruto = totalShitje - totalShpenzime;
            const pjesaFitimi = fitimiBruto / 2;
            const totalTerheqje = terheqjet.reduce((sum, t) => sum + Math.abs(t.shuma), 0);
            const totalInvestime = investimet.reduce((sum, t) => sum + t.shuma, 0);
            const pjesaFinale = pjesaFitimi - totalTerheqje + totalInvestime;
            
            const color = pjesaFinale >= 0 ? '#3B82F6' : '#FF3B30';
            
            shfaqModalUniversal(
                `💼 Sa i Mbetet ${ortaku}`,
                color,
                [
                    { label: `SA I MBETET ${ortaku.toUpperCase()}`, value: `${pjesaFinale.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD` },
                    { label: 'STATUS', value: pjesaFinale >= 0 ? '✅ Ka për të marrë' : '⚠️ Ka marrë më shumë' }
                ],
                ['Përshkrimi', 'Shuma'],
                [
                    ['Fitimi Bruto (Total)', `${fitimiBruto.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD`],
                    [`Pjesa e ${ortaku} (50%)`, `<span style="color: #34C759; font-weight: 600;">+${pjesaFitimi.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</span>`],
                    [`Investimet e ${ortaku}`, `<span style="color: #007AFF; font-weight: 600;">+${totalInvestime.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</span>`],
                    [`Tërheqjet e ${ortaku}`, `<span style="color: #FF3B30; font-weight: 600;">-${totalTerheqje.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</span>`],
                    [`<strong>SA I MBETET ${ortaku.toUpperCase()}</strong>`, `<span style="color: ${color}; font-weight: 700; font-size: 1.2em;">${pjesaFinale.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</span>`]
                ],
                `Pjesa_${ortaku}`
            );
        }
        
        // FUNKSIONI UNIVERSAL PËR TË SHFAQUR MODALIN
        function shfaqModalUniversal(title, color, summary, headers, rows, exportName) {
            // Ruaj për eksport
            window.currentCardData = { title, headers, rows, exportName };
            
            // Përditëso titullin
            document.getElementById('universal-title').textContent = title;
            
            // Krijo përmbledhjen
            const summaryDiv = document.getElementById('universal-summary');
            summaryDiv.style.background = `linear-gradient(135deg, ${color}15, ${color}25)`;
            summaryDiv.style.borderLeft = `4px solid ${color}`;
            
            let summaryHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
            summary.forEach(item => {
                summaryHTML += `
                    <div>
                        <div style="font-size: 0.85em; color: #86868b; margin-bottom: 5px;">${item.label}</div>
                        <div style="font-size: 1.8em; font-weight: 700; color: ${color};">${item.value}</div>
                    </div>
                `;
            });
            summaryHTML += '</div>';
            summaryDiv.innerHTML = summaryHTML;
            
            // Krijo header-in e tabelës
            const tableHeader = document.getElementById('universal-table-header');
            tableHeader.innerHTML = headers.map(h => `<th>${h}</th>`).join('');
            
            // Krijo rreshtat e tabelës
            const tbody = document.getElementById('universal-tbody');
            tbody.innerHTML = '';
            
            if (rows.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${headers.length}" style="text-align: center; padding: 40px; color: #86868b;">
                            <div style="font-size: 3em; margin-bottom: 10px;">📭</div>
                            <div style="font-size: 1.2em;">Nuk ka të dhëna për të shfaqur</div>
                        </td>
                    </tr>
                `;
            } else {
                rows.forEach(rowData => {
                    const row = document.createElement('tr');
                    row.innerHTML = rowData.map(cell => `<td>${cell}</td>`).join('');
                    tbody.appendChild(row);
                });
            }
            
            // Hap modalin
            document.getElementById('modal-detaje-universal').style.display = 'block';
        }
        
        // FUNKSIONI PËR EKSPORTIMIN UNIVERSAL
        function eksportoDetajetUniversal() {
            const { title, headers, rows, exportName } = window.currentCardData;
            
            if (rows.length === 0) {
                alert('⚠️ Nuk ka të dhëna për të eksportuar!');
                return;
            }
            
            // Krijo CSV
            let csvContent = `${title}\n\n`;
            csvContent += headers.join(',') + '\n';
            
            rows.forEach(row => {
                // Hiq HTML tags nga të dhënat
                const cleanRow = row.map(cell => {
                    const div = document.createElement('div');
                    div.innerHTML = cell;
                    return `"${div.textContent || div.innerText || ''}"`;
                });
                csvContent += cleanRow.join(',') + '\n';
            });
            
            // Shkarko
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${exportName}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`✅ ${title} u eksportuan me sukses!`);
        }

        // === FUNKSIONET PËR RAPORTET MUJORE ===
        
        // Variabël globale për muajin aktual
        window.currentMonthData = { month: '', year: '', transactions: [] };
        
        // Funksioni për të ngarkuar kartelat e muajve
        function ngarkoRaporteMujore() {
            const year = document.getElementById('viti-raport-mujor').value;
            const container = document.getElementById('monthly-cards-container');
            
            const monthNames = [
                'Janar', 'Shkurt', 'Mars', 'Prill', 'Maj', 'Qershor',
                'Korrik', 'Gusht', 'Shtator', 'Tetor', 'Nëntor', 'Dhjetor'
            ];
            
            container.innerHTML = '';
            
            monthNames.forEach((monthName, index) => {
                const monthNumber = String(index + 1).padStart(2, '0');
                const monthKey = `${year}-${monthNumber}`;
                
                // Filtro transaksionet për këtë muaj
                const monthTransactions = transaksionet.filter(t => {
                    const dateParts = t.data.split('-');
                    if (dateParts.length === 3) {
                        const transactionYear = dateParts[2];
                        const transactionMonth = dateParts[1];
                        return transactionYear === year && transactionMonth === monthNumber;
                    }
                    return false;
                });
                
                // Llogarit statistikat
                const shitjet = monthTransactions.filter(t => t.tipi === 'Shitje');
                const shpenzimet = monthTransactions.filter(t => t.tipi === 'Shpenzim');
                const totalShitje = shitjet.reduce((sum, t) => sum + t.shuma, 0);
                const totalShpenzime = shpenzimet.reduce((sum, t) => sum + Math.abs(t.shuma), 0);
                const fitimi = totalShitje - totalShpenzime;
                
                const isEmpty = monthTransactions.length === 0;
                
                // Krijo kartelën
                const card = document.createElement('div');
                card.className = `month-card ${isEmpty ? 'empty' : ''}`;
                if (!isEmpty) {
                    card.onclick = () => shfaqDetajeMuaji(monthName, year, monthNumber);
                }
                
                card.innerHTML = `
                    <h4>📅 ${monthName} ${year}</h4>
                    <div class="month-stats">
                        <div class="stat-item">
                            <span class="stat-label">Shitje:</span>
                            <span class="stat-value positive">${totalShitje.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Shpenzime:</span>
                            <span class="stat-value negative">${totalShpenzime.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Fitimi:</span>
                            <span class="stat-value ${fitimi >= 0 ? 'positive' : 'negative'}">${fitimi.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</span>
                        </div>
                    </div>
                    <div class="month-footer">
                        ${isEmpty ? '📭 Nuk ka transaksione' : `📊 ${monthTransactions.length} transaksione • Kliko për detaje`}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }
        
        // Funksioni për të shfaqur detajet e një muaji
        function shfaqDetajeMuaji(monthName, year, monthNumber) {
            // Filtro transaksionet për këtë muaj
            const monthTransactions = transaksionet.filter(t => {
                const dateParts = t.data.split('-');
                if (dateParts.length === 3) {
                    const transactionYear = dateParts[2];
                    const transactionMonth = dateParts[1];
                    return transactionYear === year && transactionMonth === monthNumber;
                }
                return false;
            });
            
            // Sort by date (newest first)
            monthTransactions.sort((a, b) => parseDisplayDate(b.data) - parseDisplayDate(a.data));
            
            // Llogarit statistikat
            const shitjet = monthTransactions.filter(t => t.tipi === 'Shitje');
            const shpenzimet = monthTransactions.filter(t => t.tipi === 'Shpenzim');
            const terheqjet = monthTransactions.filter(t => t.tipi === 'Tërheqje');
            const investimet = monthTransactions.filter(t => t.tipi === 'Investim');
            
            const totalShitje = shitjet.reduce((sum, t) => sum + t.shuma, 0);
            const totalShpenzime = shpenzimet.reduce((sum, t) => sum + Math.abs(t.shuma), 0);
            const totalTerheqje = terheqjet.reduce((sum, t) => sum + Math.abs(t.shuma), 0);
            const totalInvestime = investimet.reduce((sum, t) => sum + t.shuma, 0);
            const fitimi = totalShitje - totalShpenzime;
            const cashFlow = totalShitje + totalInvestime - totalShpenzime - totalTerheqje;
            
            // Ruaj për eksport
            window.currentMonthData = { 
                month: monthName, 
                year: year, 
                transactions: monthTransactions,
                stats: {
                    totalShitje,
                    totalShpenzime,
                    totalTerheqje,
                    totalInvestime,
                    fitimi,
                    cashFlow
                }
            };
            
            // Përditëso titullin
            document.getElementById('detaje-muaji-title').textContent = `📅 ${monthName} ${year}`;
            
            // Krijo përmbledhjen
            const summaryDiv = document.getElementById('muaji-summary');
            summaryDiv.style.background = 'linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(99, 102, 241, 0.1))';
            summaryDiv.style.borderLeft = '4px solid #3B82F6';
            
            summaryDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                    <div>
                        <div style="font-size: 0.85em; color: #86868b; margin-bottom: 5px;">TOTALI I SHITJEVE</div>
                        <div style="font-size: 1.6em; font-weight: 700; color: #34C759;">${totalShitje.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</div>
                    </div>
                    <div>
                        <div style="font-size: 0.85em; color: #86868b; margin-bottom: 5px;">TOTALI I SHPENZIMEVE</div>
                        <div style="font-size: 1.6em; font-weight: 700; color: #FF3B30;">${totalShpenzime.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</div>
                    </div>
                    <div>
                        <div style="font-size: 0.85em; color: #86868b; margin-bottom: 5px;">FITIMI BRUTO</div>
                        <div style="font-size: 1.6em; font-weight: 700; color: ${fitimi >= 0 ? '#34C759' : '#FF3B30'};">${fitimi.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</div>
                    </div>
                    <div>
                        <div style="font-size: 0.85em; color: #86868b; margin-bottom: 5px;">CASH FLOW</div>
                        <div style="font-size: 1.6em; font-weight: 700; color: ${cashFlow >= 0 ? '#007AFF' : '#FF3B30'};">${cashFlow.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</div>
                    </div>
                    <div>
                        <div style="font-size: 0.85em; color: #86868b; margin-bottom: 5px;">TRANSAKSIONE</div>
                        <div style="font-size: 1.6em; font-weight: 700; color: #3B82F6;">${monthTransactions.length}</div>
                    </div>
                </div>
            `;
            
            // Krijo tabelën
            const tbody = document.getElementById('muaji-tbody');
            tbody.innerHTML = '';
            
            if (monthTransactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #86868b;">
                            <div style="font-size: 3em; margin-bottom: 10px;">📭</div>
                            <div style="font-size: 1.2em;">Nuk ka transaksione për ${monthName} ${year}</div>
                        </td>
                    </tr>
                `;
            } else {
                monthTransactions.forEach(t => {
                    const row = document.createElement('tr');
                    
                    let typeColor = '#86868b';
                    let amountColor = '#1d1d1f';
                    
                    if (t.tipi === 'Shitje') {
                        typeColor = '#34C759';
                        amountColor = '#34C759';
                    } else if (t.tipi === 'Shpenzim') {
                        typeColor = '#FF3B30';
                        amountColor = '#FF3B30';
                    } else if (t.tipi === 'Tërheqje') {
                        typeColor = '#9333EA';
                        amountColor = '#9333EA';
                    } else if (t.tipi === 'Investim') {
                        typeColor = '#007AFF';
                        amountColor = '#007AFF';
                    }
                    
                    const amount = t.shuma >= 0 ? t.shuma : Math.abs(t.shuma);
                    const sign = t.shuma >= 0 ? '+' : '-';
                    
                    row.innerHTML = `
                        <td>${t.data}</td>
                        <td style="color: ${typeColor}; font-weight: 600;">${t.tipi}</td>
                        <td>${t.pershkrimi}</td>
                        <td>${t.kategoria || '-'}</td>
                        <td style="color: ${amountColor}; font-weight: 600; text-align: right;">
                            ${sign}${amount.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            // Hap modalin
            document.getElementById('modal-detaje-muaji').style.display = 'block';
        }
        
        // Funksioni për eksportimin në Excel
        function eksportoMuajinNeExcel() {
            const { month, year, transactions, stats } = window.currentMonthData;
            
            if (transactions.length === 0) {
                alert('⚠️ Nuk ka transaksione për të eksportuar!');
                return;
            }
            
            // Krijo CSV me BOM për të mbështetur karakteret shqipe
            let csvContent = '\uFEFF'; // BOM për UTF-8
            csvContent += `SUNENERGY - Raporti Mujor\n`;
            csvContent += `Muaji: ${month} ${year}\n\n`;
            
            // Statistikat
            csvContent += `PËRMBLEDHJE\n`;
            csvContent += `Totali i Shitjeve,"${stats.totalShitje.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD"\n`;
            csvContent += `Totali i Shpenzimeve,"${stats.totalShpenzime.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD"\n`;
            csvContent += `Fitimi Bruto,"${stats.fitimi.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD"\n`;
            csvContent += `Cash Flow,"${stats.cashFlow.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD"\n`;
            csvContent += `Numri i Transaksioneve,${transactions.length}\n\n`;
            
            // Transaksionet
            csvContent += `TË GJITHA TRANSAKSIONET\n`;
            csvContent += `Data,Tipi,Përshkrimi,Kategoria,Shuma (MKD)\n`;
            
            transactions.forEach(t => {
                const amount = t.shuma >= 0 ? t.shuma : Math.abs(t.shuma);
                const sign = t.shuma >= 0 ? '+' : '-';
                csvContent += `${t.data},"${t.tipi}","${t.pershkrimi}","${t.kategoria || '-'}","${sign}${amount.toLocaleString('mk-MK', {minimumFractionDigits: 2})}"\n`;
            });
            
            // Shkarko
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Raport_Mujor_${month}_${year}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`✅ Raporti për ${month} ${year} u eksportua me sukses!`);
        }
        
        // Funksioni për printim
        function printoRaportiMujor() {
            const { month, year, transactions, stats } = window.currentMonthData;
            
            const printContent = `
                <html>
                <head>
                    <title>SUNENERGY - Raporti Mujor ${month} ${year}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #3B82F6; text-align: center; }
                        .summary { background: #f9f9f9; padding: 15px; margin: 20px 0; border-radius: 8px; }
                        .summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
                        .summary-item { padding: 10px; background: white; border-radius: 4px; }
                        .summary-label { font-size: 0.9em; color: #666; }
                        .summary-value { font-size: 1.4em; font-weight: bold; margin-top: 5px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        .positive { color: #34C759; }
                        .negative { color: #FF3B30; }
                        @media print {
                            button { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <h1>⚡ SUNENERGY - Raporti Mujor</h1>
                    <h2 style="text-align: center; color: #666;">${month} ${year}</h2>
                    
                    <div class="summary">
                        <h3>📊 Përmbledhje Mujore</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-label">Totali i Shitjeve</div>
                                <div class="summary-value positive">${stats.totalShitje.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Totali i Shpenzimeve</div>
                                <div class="summary-value negative">${stats.totalShpenzime.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Fitimi Bruto</div>
                                <div class="summary-value ${stats.fitimi >= 0 ? 'positive' : 'negative'}">${stats.fitimi.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">Cash Flow</div>
                                <div class="summary-value ${stats.cashFlow >= 0 ? 'positive' : 'negative'}">${stats.cashFlow.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</div>
                            </div>
                        </div>
                        <p style="margin-top: 15px;"><strong>Numri i Transaksioneve:</strong> ${transactions.length}</p>
                    </div>
                    
                    <h3>📋 Të Gjitha Transaksionet</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipi</th>
                                <th>Përshkrimi</th>
                                <th>Kategoria</th>
                                <th>Shuma</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${transactions.map(t => {
                                const amount = t.shuma >= 0 ? t.shuma : Math.abs(t.shuma);
                                const sign = t.shuma >= 0 ? '+' : '-';
                                const colorClass = t.shuma >= 0 ? 'positive' : 'negative';
                                return `
                                    <tr>
                                        <td>${t.data}</td>
                                        <td>${t.tipi}</td>
                                        <td>${t.pershkrimi}</td>
                                        <td>${t.kategoria || '-'}</td>
                                        <td class="${colorClass}">${sign}${amount.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <p style="text-align: center; margin-top: 40px; color: #666;">
                        Krijuar më: ${new Date().toLocaleDateString('sq-AL')} ${new Date().toLocaleTimeString('sq-AL')}
                    </p>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        // Filter table
        function filtroTabelen() {
            const filterMuaji = document.getElementById('filter-muaji').value;
            const filterType = document.getElementById('filter-type').value;
            const filterPershkrimi = document.getElementById('filter-pershkrimi').value.toLowerCase().trim();
            const filterKategoria = document.getElementById('filter-kategoria').value;
            
            // Nëse ka ndonjë filtër aktiv, shfaq të gjitha transaksionet
            const hasActiveFilter = filterMuaji || filterType || filterPershkrimi || filterKategoria;
            if (hasActiveFilter && !showAllTransactions) {
                showAllTransactions = true;
                ngarkoTabelen();
            }
            
            const rows = document.querySelectorAll('#tabela-kryesore tr');
            let visibleRows = 0;
            
            rows.forEach(row => {
                // Skip expand/collapse button rows
                if (row.id === 'expand-row' || row.id === 'collapse-row') {
                    row.style.display = hasActiveFilter ? 'none' : '';
                    return;
                }
                
                if (row.cells.length > 1) {
                    const cellData = row.cells[0].textContent.trim(); // Data (DD-MM-YYYY)
                    const cellType = row.cells[1].textContent.trim(); // Tipi (mund të përmbajë emoji)
                    const cellPershkrimi = row.cells[2].textContent.toLowerCase().trim(); // Përshkrimi
                    const cellKategoria = row.cells[3].textContent.toLowerCase().trim(); // Kategoria
                    
                    let showRow = true;
                    
                    // Filter by month
                    if (filterMuaji) {
                        const dateParts = cellData.split('-');
                        if (dateParts.length === 3) {
                            const transactionMonth = dateParts[1]; // MM part from DD-MM-YYYY
                            if (transactionMonth !== filterMuaji) {
                                showRow = false;
                            }
                        }
                    }
                    
                    // Filter by type - pastro emoji-të dhe normalizoni karakteret shqipe
                    if (filterType) {
                        // Hiq emoji-të dhe normalizoni karakteret shqipe për krahasim
                        const cleanCellType = cellType.replace(/[^\w\sëËçÇ]/gi, '').trim().toLowerCase();
                        const normalizedFilter = filterType.toLowerCase();
                        
                        // Kontrollo nëse përputhet (duke normalizuar edhe ë/e)
                        const normalizedCellType = cleanCellType.replace(/ë/g, 'e');
                        const normalizedFilterType = normalizedFilter.replace(/ë/g, 'e');
                        
                        if (!normalizedCellType.includes(normalizedFilterType)) {
                            showRow = false;
                        }
                    }
                    
                    // Filter by description - kërko në përshkrim, kategori DHE tipi
                    if (filterPershkrimi) {
                        const searchableText = cellPershkrimi + ' ' + cellKategoria + ' ' + cellType;
                        if (!searchableText.includes(filterPershkrimi)) {
                            showRow = false;
                        }
                    }
                    
                    // Filter by category (dropdown filter - exact match)
                    if (filterKategoria && !cellKategoria.includes(filterKategoria.toLowerCase())) {
                        showRow = false;
                    }
                    
                    if (showRow) {
                        row.style.display = '';
                        visibleRows++;
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
            
            // Show message if no results
            const tabela = document.getElementById('tabela-kryesore');
            const emptyStateRow = tabela.querySelector('.empty-state');
            
            if (visibleRows === 0 && !emptyStateRow && transaksionet.length > 0) {
                const noResultsRow = document.createElement('tr');
                noResultsRow.className = 'no-results-row';
                noResultsRow.innerHTML = `
                    <td colspan="6" class="empty-state">
                        <h3>🔍 Nuk u gjetën rezultate</h3>
                        <p>Ndryshoni filtrat për të parë transaksione të tjera.</p>
                    </td>
                `;
                tabela.appendChild(noResultsRow);
            } else if (visibleRows > 0) {
                // Remove no results row if exists
                const noResultsRow = tabela.querySelector('.no-results-row');
                if (noResultsRow) {
                    noResultsRow.remove();
                }
            }
        }

        // Clear all filters
        function pastroFiltrat() {
            document.getElementById('filter-muaji').value = '';
            document.getElementById('filter-type').value = '';
            document.getElementById('filter-pershkrimi').value = '';
            document.getElementById('filter-kategoria').value = '';
            
            // Remove no results row if exists
            const noResultsRow = document.querySelector('.no-results-row');
            if (noResultsRow) {
                noResultsRow.remove();
            }
            
            // Reseto shfaqjen në 10 transaksione
            showAllTransactions = false;
            ngarkoTabelen();
        }

        // Initialize charts
        function initializeCharts() {
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            monthlyChart = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Shk', 'Mar', 'Pri', 'Maj', 'Qer', 'Kor', 'Gus', 'Sht', 'Tet', 'Nën', 'Dhj'],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Update chart view
        function updateChartView() {
            const filter = document.getElementById('chart-filter').value;
            const year = document.getElementById('chart-year').value;
            
            monthlyChart.data.datasets = [];
            
            const monthlyData = prepareMonthlyData(year);
            
            switch(filter) {
                case 'both':
                    monthlyChart.data.datasets = [
                        {
                            label: 'Shitjet',
                            data: monthlyData.sales,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.08)',
                            fill: true
                        },
                        {
                            label: 'Shpenzimet',
                            data: monthlyData.expenses,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.08)',
                            fill: true
                        }
                    ];
                    break;
                case 'sales':
                    monthlyChart.data.datasets = [{
                        label: 'Shitjet',
                        data: monthlyData.sales,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.12)',
                        fill: true
                    }];
                    break;
                case 'expenses':
                    monthlyChart.data.datasets = [{
                        label: 'Shpenzimet',
                        data: monthlyData.expenses,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.12)',
                        fill: true
                    }];
                    break;
                case 'profit':
                    monthlyChart.data.datasets = [{
                        label: 'Fitimi',
                        data: monthlyData.profit,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.12)',
                        fill: true
                    }];
                    break;
            }
            
            monthlyChart.update();
        }

        function prepareMonthlyData(year) {
            const monthlyData = {
                sales: new Array(12).fill(0),
                expenses: new Array(12).fill(0),
                profit: new Array(12).fill(0)
            };
            
            transaksionet.forEach(t => {
                // Parse DD-MM-YYYY format
                const dateParts = t.data.split('-');
                if (dateParts.length === 3) {
                    const transactionYear = dateParts[2];
                    const month = parseInt(dateParts[1]) - 1; // Month is 0-indexed
                    
                    if (transactionYear === year && month >= 0 && month < 12) {
                        if (t.tipi === 'Shitje') {
                            monthlyData.sales[month] += t.shuma;
                        } else if (t.tipi === 'Shpenzim') {
                            monthlyData.expenses[month] += Math.abs(t.shuma);
                        }
                    }
                }
            });
            
            for (let i = 0; i < 12; i++) {
                monthlyData.profit[i] = (monthlyData.sales[i] + (monthlyData.investments ? monthlyData.investments[i] : 0)) - monthlyData.expenses[i];
            }
            
            return monthlyData;
        }


        // Update charts
        function updateCharts() {
            updateChartView();
        }

        // Export functions (simplified for browser)
        function eksportoNeExcel() {
            try {
                // Create CSV content with DD/MM/YYYY format
                let csvContent = 'Data,Tipi,Përshkrimi,Kategoria,Shuma (MKD)\n';
                
                const sortedTransactions = [...transaksionet].sort((a, b) => parseDisplayDate(b.data) - parseDisplayDate(a.data));
                
                sortedTransactions.forEach(t => {
                    const amount = t.shuma >= 0 ? t.shuma : Math.abs(t.shuma);
                    const sign = t.shuma >= 0 ? '+' : '-';
                    csvContent += `${t.data},"${t.tipi}","${t.pershkrimi}","${t.kategoria}","${sign}${amount}"\n`;
                });
                
                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `SUNENERGY_Export_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('✅ Export-i u krijua me sukses!\nFajli CSV u shkarkua.');
            } catch (error) {
                console.error('Error exporting:', error);
                alert('⚠ Gabim në krijimin e export-it!');
            }
        }

        function printoRaportin() {
            const monthFilter = document.getElementById('muaji-raporti').value;
            
            // Filter transactions based on selected month
            let filteredTransactions = transaksionet;
            if (monthFilter) {
                filteredTransactions = transaksionet.filter(t => isDateInMonth(t.data, monthFilter));
            }
            
            // Sort by date (newest first)
            filteredTransactions = filteredTransactions.sort((a, b) => parseDisplayDate(b.data) - parseDisplayDate(a.data));
            
            // Create print content
            const printContent = createPrintableReport(filteredTransactions, monthFilter);
            
            // Open print dialog
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        function createPrintableReport(transactions, monthFilter) {
            const monthName = monthFilter ? getMonthName(monthFilter) : 'Të gjitha muajt';
            
            let content = `
                <html>
                <head>
                    <title>SUNENERGY - Raport ${monthName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #667eea; text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .summary { background: #f9f9f9; padding: 15px; margin: 20px 0; }
                    


.action-buttons {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    padding: 0 6px;
}
.btn-danger, .btn-primary {
    padding: 6px 12px;
    font-size: 12px;
}


.main-table td:last-child, .main-table th:last-child {
    width: 160px; /* zgjeron kolonën e veprimeve */
    text-align: center;
}


.btn-primary {
    background-color: #4a90e2;
    border: none;
    color: white;
    transition: background-color 0.3s ease;
}
.btn-primary:hover {
    background-color: #357abd;
}

.btn-danger {
    background-color: #e74c3c;
    border: none;
    color: white;
    transition: background-color 0.3s ease;
}
.btn-danger:hover {
    background-color: #c0392b;
}


.nav-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 16px;
    margin: 4px;
    font-size: 14px;
    font-weight: bold;
    border-radius: 8px;
    border: none;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
}
.nav-button:hover {
    transform: translateY(-2px);
}

/* Ngjyra specifike për secilin buton */
.btn-shpenzim {
    background-color: #e67e22;
}
.btn-shpenzim:hover {
    background-color: #ca6f1e;
}
.btn-shitje {
    background-color: #27ae60;
}
.btn-shitje:hover {
    background-color: #1e8449;
}
.btn-investim {
    background-color: #2980b9;
}
.btn-investim:hover {
    background-color: #21618c;
}


/* Tabela kryesore */
.main-table {
    border-collapse: collapse;
    width: 100%;
    font-size: 14px;
    background: white;
    border-radius: 8px;
    overflow: hidden;
}
.main-table th, .main-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
}
.main-table th {
    background-color: #f2f2f2;
    font-weight: bold;
}
.main-table tr:nth-child(even) {
    background-color: #f9f9f9;
}
.main-table tr:hover {
    background-color: #f1f1f1;
}

/* Filtrat */
.filter-section {
    margin: 20px 0;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}
.filter-section input, .filter-section select {
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 14px;
}
.filter-section button {
    padding: 8px 14px;
    background-color: #3498db;
    border: none;
    border-radius: 6px;
    color: white;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s ease;
}
.filter-section button:hover {
    background-color: #2980b9;
}

/* Kartat e Përmbledhjes */
.card {
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    padding: 16px;
    margin: 10px;
    background: white;
    transition: transform 0.2s ease;
}
.card:hover {
    transform: translateY(-3px);
}


body {
    background: linear-gradient(135deg, #f0f4f8, #d9e4ec);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

</style>
                </head>
                <body>
                    <h1>⚡ SUNENERGY - Financial Report</h1>
                    <h2>Periudha: ${monthName}</h2>
                    <div class="summary">
                        <h3>Përmbledhje:</h3>
                        <p>Gjithsej transaksione: ${transactions.length}</p>
            `;
            
            // Add transactions table
            if (transactions.length > 0) {
                content += `
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th onclick="sortTable(0, 'date')" style="cursor:pointer">Data ▲▼</th>
                                <th onclick="sortTable(1, 'text')" style="cursor:pointer">Tipi ▲▼</th>
                                <th onclick="sortTable(2, 'text')" style="cursor:pointer">Përshkrimi ▲▼</th>
                                <th onclick="sortTable(3, 'text')" style="cursor:pointer">Kategoria ▲▼</th>
                                <th onclick="sortTable(4, 'number')" style="cursor:pointer">Shuma ▲▼</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                transactions.forEach(t => {
                    const amount = t.shuma >= 0 ? 
                        `+${t.shuma.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD` : 
                        `-${Math.abs(t.shuma).toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD`;
                    
                    content += `
                        <tr>
                            <td>${t.data}</td>
                            <td>${t.tipi}</td>
                            <td>${t.pershkrimi}</td>
                            <td>${t.kategoria}</td>
                            <td>${amount}</td>
                        </tr>
                    `;
                });
                
                content += `
                        </tbody>
                    </table>
                `;
            } else {
                content += '<p>Nuk ka transaksione për këtë periudhë.</p>';
            }
            
            content += `
                    <p style="text-align: center; margin-top: 40px; color: #666;">
                        Krijuar më: ${new Date().toLocaleDateString('sq-AL')} ${new Date().toLocaleTimeString('sq-AL')}
                    </p>
                </body>
                </html>
            `;
            
            return content;
        }

        function getMonthName(monthValue) {
            const months = {
                '2025-01': 'Janar 2025',
                '2025-02': 'Shkurt 2025',
                '2025-03': 'Mars 2025',
                '2025-04': 'Prill 2025',
                '2025-05': 'Maj 2025',
                '2025-06': 'Qershor 2025',
                '2025-07': 'Korrik 2025',
                '2025-08': 'Gusht 2025',
                '2025-09': 'Shtator 2025',
                '2025-10': 'Tetor 2025',
                '2025-11': 'Nëntor 2025',
                '2025-12': 'Dhjetor 2025'
            };
            return months[monthValue] || monthValue;
        }

        function eksportoRaportiMujor() {
            const monthFilter = document.getElementById('muaji-raporti').value;
            
            // Filter transactions based on selected month
            let filteredTransactions = transaksionet;
            if (monthFilter) {
                filteredTransactions = transaksionet.filter(t => isDateInMonth(t.data, monthFilter));
            }
            
            try {
                const monthName = monthFilter ? getMonthName(monthFilter) : 'Të_gjitha_muajt';
                
                // Create CSV content
                let csvContent = 'Data,Tipi,Përshkrimi,Kategoria,Shuma (MKD)\n';
                
                const sortedTransactions = filteredTransactions.sort((a, b) => parseDisplayDate(b.data) - parseDisplayDate(a.data));
                
                sortedTransactions.forEach(t => {
                    const amount = t.shuma >= 0 ? t.shuma : Math.abs(t.shuma);
                    const sign = t.shuma >= 0 ? '+' : '-';
                    csvContent += `${t.data},"${t.tipi}","${t.pershkrimi}","${t.kategoria}","${sign}${amount}"\n`;
                });
                
                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `SUNENERGY_Raport_${monthName}_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('✅ Raporti mujor u eksportua me sukses!');
            } catch (error) {
                console.error('Error exporting monthly report:', error);
                alert('⚠ Gabim në krijimin e raportit mujor!');
            }
        }

        function ngarkoRaportiVjetor() {
            const year = document.getElementById('viti-raporti').value;
            
            // Filter transactions for the selected year
            const yearlyTransactions = transaksionet.filter(t => isDateInYear(t.data, year));
            
            // Calculate yearly summary
            const shitjet = yearlyTransactions.filter(t => t.tipi === 'Shitje');
            const shpenzimet = yearlyTransactions.filter(t => t.tipi === 'Shpenzim');
            const terheqjet = yearlyTransactions.filter(t => t.tipi === 'Tërheqje');
            
            const totalShitje = shitjet.reduce((s,t)=>s+t.shuma,0);
            const totalShpenzime = Math.abs(shpenzimet.reduce((s,t)=>s+t.shuma,0));
            const totalInvestime = investimet.reduce((s,t)=>s+t.shuma,0);
            const fitimiBruto = totalShitje - totalShpenzime;
            
            // Display yearly summary
            document.getElementById('permbledhja-vjetore').innerHTML = `
                <div style="background: rgba(255, 255, 255, 0.9); padding: 20px; border-radius: 12px; margin: 15px 0;">
                    <h4>📊 Përmbledhja e Vitit ${year}</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div>
                            <p><strong>Totali i Shitjeve:</strong> ${totalShitje.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</p>
                            <p><strong>Totali i Shpenzimeve:</strong> ${totalShpenzime.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</p>
                        </div>
                        <div>
                            <p><strong>Fitimi Bruto:</strong> ${fitimiBruto.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</p>
                            <p><strong>Gjithsej Transaksione:</strong> ${yearlyTransactions.length}</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Create monthly breakdown
            let monthlyBreakdown = '<div style="background: rgba(255, 255, 255, 0.9); padding: 20px; border-radius: 12px;"><h4>📅 Analiza Mujore</h4><table style="width: 100%; margin-top: 10px; border-collapse: collapse;"><thead><tr style="background: #f5f5f5;"><th style="padding: 8px; border: 1px solid #ddd;">Muaji</th><th style="padding: 8px; border: 1px solid #ddd;">Shitjet</th><th style="padding: 8px; border: 1px solid #ddd;">Shpenzimet</th><th style="padding: 8px; border: 1px solid #ddd;">Fitimi</th></tr></thead><tbody>';
            
            const monthNames = ['Janar', 'Shkurt', 'Mars', 'Prill', 'Maj', 'Qershor', 'Korrik', 'Gusht', 'Shtator', 'Tetor', 'Nëntor', 'Dhjetor'];
            
            for (let month = 1; month <= 12; month++) {
                const monthStr = month.toString().padStart(2, '0');
                const monthlyTransactions = yearlyTransactions.filter(t => {
                    const parts = t.data.split('-');
                    return parts.length === 3 && parts[1] === monthStr;
                });
                
                const monthShitje = monthlyTransactions.filter(t => t.tipi === 'Shitje').reduce((sum, t) => sum + t.shuma, 0);
                const monthShpenzime = Math.abs(monthlyTransactions.filter(t => t.tipi === 'Shpenzim').reduce((sum, t) => sum + t.shuma, 0));
                const monthInvestime = monthlyTransactions.filter(t => t.tipi === 'Investim').reduce((sum, t) => sum + t.shuma, 0);
                const monthFitimi = monthShitje - monthShpenzime;
                
                monthlyBreakdown += `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">${monthNames[month-1]}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${monthShitje.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${monthShpenzime.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</td>
                        <td style="padding: 8px; border: 1px solid #ddd; color: ${monthFitimi >= 0 ? '#34C759' : '#FF3B30'}">${monthFitimi.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</td>
                    </tr>
                `;
            }
            
            monthlyBreakdown += '</tbody></table></div>';
            document.getElementById('analiza-mujore').innerHTML = monthlyBreakdown;
        }

        function printoRaportiVjetor() {
            const year = document.getElementById('viti-raporti').value;
            const yearlyTransactions = transaksionet.filter(t => isDateInYear(t.data, year));
            
            const printContent = createYearlyPrintReport(yearlyTransactions, year);
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        function createYearlyPrintReport(transactions, year) {
            // Calculate totals
            const shitjet = transactions.filter(t => t.tipi === 'Shitje');
            const shpenzimet = transactions.filter(t => t.tipi === 'Shpenzim');
            
                        const investimet = transactions.filter(t => t.tipi === 'Investim');
const totalShitje = shitjet.reduce((sum, t) => sum + t.shuma, 0);
            const totalShpenzime = Math.abs(shpenzimet.reduce((sum, t) => sum + t.shuma, 0));
            const fitimiBruto = totalShitje - totalShpenzime;
            
            return `
                <html>
                <head>
                    <title>SUNENERGY - Raport Vjetor ${year}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #667eea; text-align: center; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .summary { background: #f9f9f9; padding: 15px; margin: 20px 0; }
                    


.action-buttons {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    padding: 0 6px;
}
.btn-danger, .btn-primary {
    padding: 6px 12px;
    font-size: 12px;
}


.main-table td:last-child, .main-table th:last-child {
    width: 160px; /* zgjeron kolonën e veprimeve */
    text-align: center;
}


.btn-primary {
    background-color: #4a90e2;
    border: none;
    color: white;
    transition: background-color 0.3s ease;
}
.btn-primary:hover {
    background-color: #357abd;
}

.btn-danger {
    background-color: #e74c3c;
    border: none;
    color: white;
    transition: background-color 0.3s ease;
}
.btn-danger:hover {
    background-color: #c0392b;
}


.nav-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 16px;
    margin: 4px;
    font-size: 14px;
    font-weight: bold;
    border-radius: 8px;
    border: none;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
}
.nav-button:hover {
    transform: translateY(-2px);
}

/* Ngjyra specifike për secilin buton */
.btn-shpenzim {
    background-color: #e67e22;
}
.btn-shpenzim:hover {
    background-color: #ca6f1e;
}
.btn-shitje {
    background-color: #27ae60;
}
.btn-shitje:hover {
    background-color: #1e8449;
}
.btn-investim {
    background-color: #2980b9;
}
.btn-investim:hover {
    background-color: #21618c;
}


/* Tabela kryesore */
.main-table {
    border-collapse: collapse;
    width: 100%;
    font-size: 14px;
    background: white;
    border-radius: 8px;
    overflow: hidden;
}
.main-table th, .main-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
}
.main-table th {
    background-color: #f2f2f2;
    font-weight: bold;
}
.main-table tr:nth-child(even) {
    background-color: #f9f9f9;
}
.main-table tr:hover {
    background-color: #f1f1f1;
}

/* Filtrat */
.filter-section {
    margin: 20px 0;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}
.filter-section input, .filter-section select {
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 14px;
}
.filter-section button {
    padding: 8px 14px;
    background-color: #3498db;
    border: none;
    border-radius: 6px;
    color: white;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s ease;
}
.filter-section button:hover {
    background-color: #2980b9;
}

/* Kartat e Përmbledhjes */
.card {
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    padding: 16px;
    margin: 10px;
    background: white;
    transition: transform 0.2s ease;
}
.card:hover {
    transform: translateY(-3px);
}


body {
    background: linear-gradient(135deg, #f0f4f8, #d9e4ec);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

</style>
                </head>
                <body>
                    <h1>⚡ SUNENERGY - Raport Vjetor ${year}</h1>
                    <div class="summary">
                        <h3>Përmbledhje Vjetore:</h3>
                        <p><strong>Totali i Shitjeve:</strong> ${totalShitje.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</p>
                        <p><strong>Totali i Shpenzimeve:</strong> ${totalShpenzime.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</p>
                        <p><strong>Fitimi Bruto:</strong> ${fitimiBruto.toLocaleString('mk-MK', {minimumFractionDigits: 2})} MKD</p>
                        <p><strong>Gjithsej Transaksione:</strong> ${transactions.length}</p>
                    </div>
                    <p style="text-align: center; margin-top: 40px; color: #666;">
                        Krijuar më: ${new Date().toLocaleDateString('sq-AL')} ${new Date().toLocaleTimeString('sq-AL')}
                    </p>
                </body>
                </html>
            `;
        }

        function eksportoRaportiVjetor() {
            const year = document.getElementById('viti-raporti').value;
            const yearlyTransactions = transaksionet.filter(t => isDateInYear(t.data, year));
            
            try {
                // Create CSV content
                let csvContent = `SUNENERGY - Raport Vjetor ${year}\n\n`;
                csvContent += 'Data,Tipi,Përshkrimi,Kategoria,Shuma (MKD)\n';
                
                const sortedTransactions = yearlyTransactions.sort((a, b) => parseDisplayDate(b.data) - parseDisplayDate(a.data));
                
                sortedTransactions.forEach(t => {
                    const amount = t.shuma >= 0 ? t.shuma : Math.abs(t.shuma);
                    const sign = t.shuma >= 0 ? '+' : '-';
                    csvContent += `${t.data},"${t.tipi}","${t.pershkrimi}","${t.kategoria}","${sign}${amount}"\n`;
                });
                
                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `SUNENERGY_Raport_Vjetor_${year}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('✅ Raporti vjetor u eksportua me sukses!');
            } catch (error) {
                console.error('Error exporting yearly report:', error);
                alert('⚠ Gabim në krijimin e raportit vjetor!');
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Aplikacioni u ngarkua...');
            
            // Detect Safari
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            
            console.log('Browser detection:', { isSafari, isIOS });
            
            // Lock body scroll when login is active
            document.body.classList.add('login-active');
            
            // Add Safari-specific styles
            const style = document.createElement('style');
            style.textContent = `
                @keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    25% { transform: translateX(-5px); }
                    75% { transform: translateX(5px); }
                }
                
                .login-container {
                    transition: opacity 0.3s ease, transform 0.3s ease;
                }
                
                /* Safari-specific fixes */
                ${isSafari || isIOS ? `
                    .login-input {
                        font-size: 16px !important;
                        transform: scale(1) !important;
                        -webkit-transform: scale(1) !important;
                        border-radius: 16px !important;
                        -webkit-border-radius: 16px !important;
                    }
                    
                    .login-input:focus {
                        transform: scale(1) !important;
                        -webkit-transform: scale(1) !important;
                        outline: none !important;
                        -webkit-appearance: none !important;
                    }
                    
                    .login-btn {
                        -webkit-appearance: none !important;
                        border-radius: 16px !important;
                        -webkit-border-radius: 16px !important;
                    }
                    
                    body.login-active {
                        height: 100vh !important;
                        height: -webkit-fill-available !important;
                        -webkit-overflow-scrolling: touch;
                    }
                ` : ''}
            `;
            document.head.appendChild(style);
            
            // Set viewport for Safari compatibility
            let viewport = document.querySelector('meta[name="viewport"]');
            if (!viewport) {
                viewport = document.createElement('meta');
                viewport.name = 'viewport';
                document.head.appendChild(viewport);
            }
            
            // Safari-specific viewport settings
            if (isSafari || isIOS) {
                viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover';
            } else {
                viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
            }
            
            // Focus removed since no input fields needed
            console.log('Sistemi i hyrjes është gati!');
        });
    

// --- Sorting (clickable headers) ---
let sortState = {};

function sortTable(columnIndex, type) {
  const tbody = document.querySelector('.main-table tbody');
  if (!tbody) return;

  // Vetëm rreshtat e të dhënave (me 6 kolona), jo placeholder-i me colspan
  const rows = Array.from(tbody.querySelectorAll('tr')).filter(tr => tr.children.length === 6 && !tr.querySelector('.empty-state'));
  if (rows.length === 0) return;

  // Toggle asc/desc
  sortState[columnIndex] = (sortState[columnIndex] === 'asc') ? 'desc' : 'asc';
  const dir = sortState[columnIndex] === 'asc' ? 1 : -1;

  const parseNumber = (s) => {
    const cleaned = s.replace(/[^\d,\.\-]/g, '').replace(/\s/g, '');
    const normalized = cleaned.replace(/,/g, '');
    const num = parseFloat(normalized);
    return isNaN(num) ? 0 : num;
  };

  const toTime = (s) => {
    // DD-MM-YYYY ose YYYY-MM-DD
    let m = s.match(/(\d{2})-(\d{2})-(\d{4})/);
    if (m) return new Date(`${m[3]}-${m[2]}-${m[1]}`).getTime();
    m = s.match(/(\d{4})-(\d{2})-(\d{2})/);
    if (m) return new Date(`${m[1]}-${m[2]}-${m[3]}`).getTime();
    return 0;
  };

  rows.sort((a, b) => {
    let aText = a.children[columnIndex].innerText.trim();
    let bText = b.children[columnIndex].innerText.trim();

    if (type === 'number') {
      return dir * (parseNumber(aText) - parseNumber(bText));
    } else if (type === 'date') {
      return dir * (toTime(aText) - toTime(bText));
    } else {
      return dir * aText.localeCompare(bText, 'sq', { sensitivity: 'base' });
    }
  });

  // Zëvendëso rreshtat në tbody
  tbody.innerHTML = '';
  rows.forEach(r => tbody.appendChild(r));
}

// ========== MOBILE NAVIGATION FUNCTIONS ==========

// Toggle Sidebar (Mobile Menu)
function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    
    if (sidebar && overlay) {
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
        
        // Prevent body scroll when sidebar is open
        if (sidebar.classList.contains('active')) {
            document.body.style.overflow = 'hidden';
        } else {
            document.body.style.overflow = '';
        }
    }
}

// Toggle FAB Menu (Floating Action Button)
function toggleFabMenu() {
    const fabMenu = document.getElementById('fabMenu');
    if (fabMenu) {
        fabMenu.classList.toggle('active');
    }
}

// Close FAB menu when clicking outside
document.addEventListener('click', function(event) {
    const fab = document.querySelector('.mobile-fab');
    const fabMenu = document.getElementById('fabMenu');
    
    if (fab && fabMenu && !fab.contains(event.target)) {
        fabMenu.classList.remove('active');
    }
});

// Close sidebar when clicking menu items (mobile)
document.addEventListener('DOMContentLoaded', function() {
    const menuButtons = document.querySelectorAll('.menu-button');
    
    menuButtons.forEach(button => {
        button.addEventListener('click', function() {
            // On mobile, close sidebar after clicking
            if (window.innerWidth <= 768) {
                const sidebar = document.querySelector('.sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                
                if (sidebar && overlay) {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
            }
        });
    });
});

// Handle window resize - close sidebar if switching to desktop
window.addEventListener('resize', function() {
    if (window.innerWidth > 768) {
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        
        if (sidebar && overlay) {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }
    }
});

</script>
</body>
</html>
